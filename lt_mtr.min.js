/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(a){var e,s;window.lt_mtr={};var c,m={},h={},n=!1,o=[],l=function(t){this.host=t,this.n=0,this.sum=0,this.avg=0,this.min=99999999999,this.max=0,this.square_sum=0,this.stdev=0,this.update=function(t,e){lt_mtr.click_mtr?(this.n=e,this.avg=t):(this.n++,this.sum+=t,this.square_sum+=t*t,this.avg=this.sum/this.n,this.min=t<this.min?t:this.min,this.max=t>this.max?t:this.max,this.stdev=Math.sqrt(this.square_sum/this.n-this.avg*this.avg),this.avg)}},d=function(t){this.hosts={},this.host="",this.hits=0,this.hop=t,this.increment=function(t){lt_mtr.click_mtr?(this.hits=t,this.hosts[this.host]=t):(this.hits++,this.hosts[this.host]=this.hosts[this.host]+1)},this.update=function(t){this.hosts[t]=0,this.host=t}};function r(){var t=a("#new_trace_host").val();return t?lt_mtr.click_mtr&&validate.ipv4_validator(t,!0)?(alert("This version of traceroute requires that an IP address be used to specify the host (IPv4 specifically)."),!1):(lt_mtr.stop(),a("#trace_details").html(""),e.find(".spinner").show(),a("#new_trace_stop").show(),a("#new_trace_run").hide(),live_toolbox.set_tool_status(lt_mtr,!0),a("#mtr_table").show(),m={},h={},c.set_items([]),void(s=lt_mtr.click_mtr?a.comet.command_subscribe({broker:"CommandStream",command:"click_mtr",host:_.escape(t),interface:_.escape(a("#new_trace_iface").val())},p):a.comet.command_subscribe({broker:"CommandStream",command:"mtr",host:_.escape(t),c:100,interface:s3node.nat_enabled?_.escape(a("#new_trace_iface").val()):"bridgehost",no_dns:n},p))):(alert("Please specify a host."),!1)}function u(){var s,n=[],o=0;return _.each(h,function(e){var t=_.keys(e.hosts),i=!0;_.each(t,function(t){s=e.hop.toString().concat(",",t),s=m[s],s={id:o,hop:i?e.hop:"",host:t,count:s.n,used:(e.hosts[t]/e.hits*1*100).toFixed(0),min:s.min.toFixed(2),avg:s.avg.toFixed(2),max:s.max.toFixed(2),stdev:s.stdev.toFixed(2)},o++,n.push(s),i=!1})}),n}function p(t){var e;t.data.chunk&&(t.data.chunk.match(/nameservers/g)?(n=!0,lt_mtr.stop(),r()):t.data.chunk.match(/inactive interface/g)&&(a("#mtr_table").hide(),alert("Selected interface not available."),lt_mtr.stop()),e=t.data.chunk.split("\n"),_.each(e,function(t){var e,i,s,n,o,r;lt_mtr.click_mtr?0==t.indexOf("<traceroute ")&&(i=a(t).attr("hop"),(s=null==(s=h[i])?new d(i):s).update(a(t).attr("node_ip")),n=(h[i]=s).host,o=i.concat(",",n),null==(r=m[o])&&(r=new l(n)),e=parseInt(a(t).attr("count")),r.update(1e3*parseFloat(a(t).attr("rtt_avg")),e),m[o]=r,s.increment(e),c.set_items(u())):(t=t.split(" "),i=parseInt(t[1])+1,"h"==t[0]?((s=null==(s=h[i])?new d(i):s).update(t[2]),h[i]=s):"p"==t[0]&&null!=(s=h[i])&&(n=s.host,o=i.toString().concat(",",n),(r=null==(r=m[o])?new l(n):r).update(parseInt(t[2])/1e3),m[o]=r,s.increment(),c.set_items(u())))})),t.data.completed&&lt_mtr.stop()}lt_mtr.init=function(t){e=a("#lt_mtr_tmpl").tmpl().appendTo(t),a("#new_trace_run").click(r),a("#new_trace_stop").click(lt_mtr.stop),a("#new_trace_host").enterKey(r),c=make_flex_table({items:[],container:"#mtr_table",columns:{hop:{l:"Hop",render:"[%= item.hop %]",sort_by:function(t){return t.id}},host:{l:"Host",render:"[%= item.host %]",sort_by:!1},used:{l:"Used",render:"[%= item.used %]%",sort_by:!1},count:{l:"Count",render:"[%= item.count %]",sort_by:!1},min:{l:"Min",render:"[%= item.min %]",sort_by:!1},avg:{l:"Latency (ms)",render:"[%= item.avg %]",sort_by:!1},max:{l:"Max",render:"[%= item.max %]",sort_by:!1},stdev:{l:"Std Dev",render:"[%= item.stdev %]",sort_by:!1}},selected_fields:["hop","host","count","avg"],unselectable_fields:["min","max","used","stdev"],default_sort:"+hop",row_id_prefix:!0,no_items_html:"Starting test...",footer:!0,keep_page:!0,loading:!0,simple_footer:!0,items_per_page_options:[500]}),s3node.nat_enabled?a("#new_trace_iface").html("<option value='wired0'>Internet 1</option>                                   <option value='wired1'>Internet 2</option>                                   <option value='"+Mkiconf.wired.cellular_interface+"'>Cellular</option>"):lt_mtr.click_mtr?lt_mtr.update_interface_menu():a("#if_options").hide()},lt_mtr.stop=function(){s&&s.stop(),lt_mtr.click_mtr&&(terminator=a.comet.command_subscribe({broker:"CommandStream",command:"click_mtr",terminate:"true"},function(){}),terminator&&terminator.stop()),e.find(".spinner").hide(),live_toolbox.set_tool_status(lt_mtr,!1),a("#new_trace_run").show(),a("#new_trace_stop").hide()},lt_mtr.set_interfaces=function(t){for(i in o=[],t){var e=t[i].ip;o.push(e)}},lt_mtr.update_interface_menu=function(){for(i in a("#new_trace_iface option").remove(),o){var t=o[i];a("<option></option>").attr("value",t).text(t).appendTo("#new_trace_iface")}}}(jQuery);