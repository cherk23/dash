/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
function make_map3_overlay(f,e,d,a){var g,u,s,_,h,v,y,l,p,c,b,x,w,M,k,L,G,C,P,T=window.jQuery,z=[],E={},i=0,o=0,n=0,I=0,S=null,A=[],O={},N=[],R={},D=0,B=0,Q=[],Z=[],r=!1,H=null,Y=!1,W=!1,q=null,F={},X=!1,J=[],K={};function $(e){for(var t in this.prio=Math.floor(e.prio||0),this.ctx=null,this.empty=!0,{init:1,noder:1,sizer:1,decorator:1,backgrounder:1,nobuf:1,nodisp:1,nobounds:1,refreshers:1,disabled:1,name:1,setprefs:1,prefsmenu:1,colorer:1,tooltip_labeler:1})this[t]=e[t]}function U(){var e,t,n,i,o,a=g,r=u;for(R={},g=u=s=null,e=z.length-1;0<=e;--e)if(!(n=z[e]).disabled&&(o=!1,!g&&n.sizer&&(g=o=n),!u&&n.colorer&&(u=o=n),!s&&n.tooltip_labeler&&(s=n),i=n.refreshers))for(t=0;t<i.length;++t)R[i[t]]=o?2:1;a===g&&r===u||!k||_e()}function V(e){if(!e.name||E[e.name])throw new Error("duplicate layer");var t,n=new $(e);for(E[e.name]=n,t=0;t<z.length&&z[t].prio<=n.prio;++t);return z.splice(t,0,n),n.setprefs&&n.setprefs.call(n,K,a),U(),n}function ee(){var e=f.getCurrentMapType();return e!==G_SATELLITE_MAP&&e!==G_HYBRID_MAP}function te(e,t,n){ee()?e.className="map3bg_light":e.className="map3bg_dark"}function ne(e,t){var n="neighbors."+(t.type||"Map"),i=(ee(),window.Mkijson?Mkijson.n.meta:nodes_meta);"x"==(t[n]||"")&&(t[n]=null),null!=t.neighbors&&"x"!=t.neighbors&&(t.neighbors=null),this.disabled="x"==t.neighbors,this.disabled||d.show3||!i.lat||i.curnbrs||data3_load.ajax("n",{f:"curnbrs",t0:i.t0,t1:i.t1})}function ie(e,t,n){e=e.getContext("2d"),n=(n=n["neighbors."+(n.type||"Map")])||(ee()?"d":"l");e.lineCap="butt",e.lineJoin="miter",e.strokeStyle="d"==n?"rgba(30,47,16,0.2)":"r"==n?"rgba(200,24,0,0.4)":"rgba(210,219,220,0.32)"}function oe(e,t,i,n){var o,a,r,s,l,p,d,g,u,h=i.fromLatLngToDivPixel(e.latlng),c=this.count;if(0==e.latlng.lat()&&0==e.latlng.lng())return!1;function f(e,t,n){n<=0||((u=u||e.begin(!0)).lineWidth=n<4?2:n<22?3:5,u.beginPath(),p=i.fromLatLngToDivPixel(t.latlng),Me(u,h,p),u.stroke(),++e.count)}if(g=e.n.curnbrs)for(o in g)!(l=v[o])||!(l.n.id<e.n.id)&&l.disp&&l.n.curnbrs&&l.n.curnbrs[e.n.id]&&t.containsLatLng(l.latlng)||0==l.latlng.lat()&&0==l.latlng.lng()||f(this,l,g[o]);else if(g=e.n.nbrs){for(o in g)if((l=v[o])&&(l.n.id<e.n.id||!l.disp||!l.n.nbrs||!l.n.nbrs[e.n.id]||!t.containsLatLng(l.latlng))&&(0!=l.latlng.lat()||0!=l.latlng.lng())){for(a in rateprod=d=0,g[o])s=(r=g[o][a])[1]*r[2],r[0]<1e3&&s>rateprod&&(d=r[0],rateprod=s);f(this,l,d)}}else if(g=e.n.neighbors)for(o=0;o<g.length;++o)if(l=v[g[o].id]){if((d=0)==l.latlng.lat()&&0==l.latlng.lng())continue;f(this,l,d=g[o].stats&&g[o].stats[0]?g[o].stats[0].rssi_11b||0:d)}return"undefined"!=typeof G_vmlCanvasManager&&Math.floor(c/250)!=Math.floor(this.count/250)||void 0}function ae(e){var t,n,i;if(e.setprefs&&e.setprefs.call(e,K,a),e.disabled)re(e,!0);else{if(e.canvas)(n=e.canvas).width=L,n.height=G,n.style.visibility="hidden";else{for(e.canvas=n=document.createElement("canvas"),n.width=L,n.height=G,n.style.position="absolute",n.style.visibility="hidden",n.style.zIndex=e.prio,T("body").append(n),"undefined"!=typeof G_vmlCanvasManager&&(G_vmlCanvasManager.initElementNoFix?e.canvas=G_vmlCanvasManager.initElementNoFix(e.canvas):e.canvas=G_vmlCanvasManager.initElement(e.canvas)),t=z.length-1,i=null;0<=t&&z[t]!=e;--t)i=z[t].canvas||z[t].xcanvas||i;f.getPane(G_MAP_MARKER_PANE).insertBefore(e.canvas,i)}e.empty=!0,e.init&&(e.unbegin(),e.init.call(e,e.canvas,K,a),e.xcanvas&&e.init.call(e,e.xcanvas,K,a))}}function re(e,t){var n=e.canvas;!n||n.width==L&&n.height==G?n&&!e.empty&&(e.unbegin(),n.style.visibility="hidden",n.getContext("2d").clearRect(0,0,L,G),e.empty=!0):ae(e),t&&e.xcanvas&&(e.xcanvas.style.visibility="hidden")}function se(e,t){return t.n["status#"]-e.n["status#"]||e.z-t.z||e.latlng.lng()-t.latlng.lng()||e.id-t.id}function le(){var e,t,n;for(e in _.sort(se),h.sort(function(e,t){return e.latlng.lat()-t.latlng.lat()}),v)t=v[e],n?n.extend(t.latlng):n=new GLatLngBounds(t.latlng,t.latlng);n&&(n=n.toSpan(),M=n.latRadians()*n.lngRadians()/(_.length||1))}function pe(e,t){var n,i,o,a,r=T("#nodemap_tooltip");r.length||(jQuery("body").append('<div id="nodemap_tooltip"></div>'),r=T("#nodemap_tooltip")),r.length&&e?(b=e,function(){var e,t,n,i=f.fromLatLngToContainerPixel(b.latlng),o=[0,0,0,0];if(b.n.gateway_route)for(e=b.n.gateway_route.split(" "),n=0;n<e.length;++n)(t=v[e[n]])&&(o[(t=f.fromLatLngToContainerPixel(t.latlng)).y<i.y?0:2]++,Math.abs(t.y-i.y)<30&&o[t.x<i.x?3:1]++);for(w=2,n=0;n<4;++n)o[n]<o[w]&&(w=n)}(),a="<div style='position:relative'><div id='nodemap_tooltip_pointer' class='hhptr_ups'>&nbsp;</div><table class='lean'><tr><td class='hhsh_tls' style='width:4px;height:4px'></td><td class='hhsh_ts' style='height:4px'></td><td class='hhsh_trs' style='width:4px;height:4px'></td></tr><tr><td class='hhsh_ls' style='width:4px'></td><td><div class='nodemap_tooltip_contents'><table class='lean'><tr><td>"+node3_render_status(e.n,!0)+"</td><td>Â </td><td>",a+=s?s.tooltip_labeler.call(s,e,K):node3_render_name(e.n),r.html(a+="</td></tr></table></div></td><td class='hhsh_rs' style='width:4px'></td></tr><tr><td class='hhsh_bls' style='width:4px;height:4px'></td><td class='hhsh_bs' style='height:4px'></td><td class='hhsh_brs' style='width:4px;height:4px'></td></tr></table></div>"),n=r,i=T(f.getContainer()).offset(),o=n.width(),e=n.height(),(a=f.fromLatLngToContainerPixel(b.latlng)).x+=i.left,a.y+=i.top,i=n.find("#nodemap_tooltip_pointer"),0==w?(n.css({top:a.y-b.img.height-e-6,left:a.x-o/2,zIndex:100}),i.css({top:e-5,left:o/2-4.5}),i[0].className="hhptr_downs"):1==w?(n.css({top:a.y-e/2-b.img.height/2,left:a.x+b.img.width/2+9,zIndex:100}),i.css({top:e/2-4.5,left:-5}),i[0].className="hhptr_lefts"):3==w?(n.css({top:a.y-e/2-b.img.height/2,left:a.x-b.img.width/2-o-6,zIndex:100}),i.css({top:e/2-4.5,left:o-5}),i[0].className="hhptr_rights"):(n.css({top:a.y+9,left:a.x-o/2,zIndex:100}),i.css({top:-5,left:o/2-4.5}),i[0].className="hhptr_ups"),r.fadeIn(200),clearTimeout(x),x=null):r.length&&!x&&b&&(x=setTimeout(K.clear_tooltip,t?0:500))}function de(e){var t;(e!==b||e&&x)&&pe(e),t=l,(l=e||p)!==t&&(xe(t),xe(l),je(),d.onnodehover&&d.onnodehover(l,K))}function ge(e){var t,n;"mouseover"===e.type&&x?(clearTimeout(x),x=null,de(b)):"mouseout"===e.type&&b&&!x?(x=setTimeout(K.clear_tooltip,500),d.show3&&de(null)):"mousemove"===e.type&&b&&!Y&&(n=(t=T("#nodemap_tooltip")).offset(),(0==w?e.pageY>n.top+t.height()-10&&8<Math.abs(e.pageX-n.left-t.width()/2):1==w?e.pageX<n.left+10&&8<Math.abs(e.pageY-n.top-t.height()/2):3==w?e.pageX>n.left+t.width()-10&&8<Math.abs(e.pageY-n.top-t.height()/2):e.pageY<n.top+10&&8<Math.abs(e.pageX-n.left-t.width()/2))&&(n=T(f.getContainer()).offset(),de(Le(f.fromContainerPixelToLatLng(new GPoint(e.pageX-n.left,e.pageY-n.top))))))}function ue(){K.map_type_changing||(clearTimeout(H),H=setTimeout(function(){var e=map3_type_is_custom(f)?"."+a.type:"",t=f.getCenter();a["lat"+e]=t.lat(),a["lng"+e]=t.lng(),a["zoom"+e]=f.getZoom(),Be(0),H=null},1600))}function he(e){16==(e=e||window.event).keyCode&&(X=!0)}function ce(e){16==(e=e||window.event).keyCode&&(X=!1)}function fe(e,t){var n,i,o,a,r="pno",s=g,l=u,p=K.node_scalestep;return(n=e.tags)&&(0<=n.indexOf(" triangle ")?r="ptr":0<=n.indexOf(" square ")?r="psq":0<=n.indexOf(" star ")&&(r="pst")),s&&(p=s.sizer.call(s,p,e,K),p=Math.max(Math.min(Math.round(p),100),-2),o=p<=2?Math.max(Math.round(p),-2)+2:.34+.031*Math.sqrt(p)),i=l?(i=l.colorer.call(l,e,K),Math.max(Math.min(Math.round(i||0),8),0)):e["status#"]||0,e=(p=r+"-z"+p+(s?"z":""))+"-s"+i+"-g"+(e.is_gateway?1:0),t&&"partial"==t.highlight?e+="-hx":t&&t.highlight&&(e+="-h"),(a=O[e])||(O[e]=a={image:new Image,color:i},a.image.onload=function(){s&&(this.width=Math.round(this.width*o),this.height=Math.round(this.height*o)),D=Math.max(this.width,D),B=Math.max(this.height,B),a.width=this.width,a.height=this.height,a.horiz_offset=Math.ceil(this.width/2),a.vert_offset=Math.ceil(this.height/2),a.top_offset=this.height,a.bot_offset=0,a.shape=r;var e=new GIcon;e.iconSize=new GSize(this.width,this.height),e.iconAnchor=new GPoint(a.horiz_offset,a.top_offset),e.infoWindowAnchor=new GPoint(a.horiz_offset,a.vert_offset),e.image=e.transparent=e.printImage=e.mozPrintImage=Mkiconf.images+"onebyone.gif",e.shadow=e.printShadow=null,a.gicon=e,me(a)},n=p+"/dingle-"+e+".png",s&&(n=n.replace(/-z-?\d+z/g,"-z9")),a.image.src=Mkiconf.images+"dingle-"+n),a}function me(e){for(var t in e.markers_waiting||{})xe(v[t],!0);if(e.markers_waiting&&delete e.markers_waiting,N.length){for(t=0;t<N.length;++t)N[t]==e?(N.splice(t,1),--t):!0===N[t]&&(N=[]);0==N.length&&K.redraw(!0)}}function _e(){var e,t,n,i=!1;for(e in v)(n=fe((t=v[e]).n))!==t.img&&(t.img=n,t.highlight&&xe(t),i=!0);return i}function ve(){return Y=!0,re(E.route),p==this._meraki_node&&f.closeInfoWindow(),K.clear_tooltip(),!1}function ye(){var e,t,n,i,o=this._meraki_node,a=[];if(Y=!1,o){if(e=this.getLatLng().lat()-o.latlng.lat(),t=this.getLatLng().lng()-o.latlng.lng(),!d.show3)for(n in checkbox3.checked)a.push(v[n]);for(!d.show3&&this._meraki_node.n.checked||a.push(this._meraki_node),n=a.length-1;0<=n;--n)(i=a[n]).latlng=new GLatLng(i.latlng.lat()+e,i.latlng.lng()+t),i.z=GOverlay.getZIndex(i.latlng.lat());le(),De(a),K.refresh()}}function be(){Se(this._meraki_node,!0)}function xe(e,t){var n,i,o,a,r;if(e){if(o=e.marker,p==e||!d.show3&&e.n.checked?r=!0:e.in_pinned_route&&(r="partial"),!!r!=!!e.highlight&&(c+=r?1:-1),r?e.highlight=fe(e.n,{highlight:r}):delete e.highlight,e.highlight||e==l){if(!(a=e.highlight||e.img)||o&&o.getIcon()==a.gicon)return;if(!a.gicon){if(a.markers_waiting=a.markers_waiting||{},a.markers_waiting[e.id]=!0,a==e.img||!e.img||!e.img.gicon)return;a=e.img}for(n=0;n<A.length;++n)if(A[n].getIcon()==a.gicon&&A[n].isHidden()){i=A[n];break}i||(r=!(!Mkiconf.read_only&&!d.read_only),i=new GMarker(f.getCenter(),{icon:a.gicon,bouncy:!1,clickable:r,draggable:!r}),GEvent.addListener(i,"click",be),r||(GEvent.addListener(i,"dragstart",ve),GEvent.addListener(i,"dragend",ye)),f.addOverlay(i),i.hide(),A.push(i)),(e.marker=i)._meraki_node=e,i.setLatLng(e.latlng),i.show()}else delete e.marker;o&&(o.hide(),delete o._meraki_node),t&&!S&&(S=setTimeout(function(){S&&(S=null,je())},100))}}function we(e,t,n){if(e&&e.n.gateway_route){var i,o,a,r,s=t.ctx,l={};for(s.lineWidth=n?5:3,s.lineCap="round",s.lineJoin="miter",s.strokeStyle=n?"rgba(119,142,233,0.8)":"rgba(215,110,211,0.8)",a=e.n.gateway_route.split(" "),l=f.fromLatLngToDivPixel(e.latlng),s.beginPath(),i=0;i<a.length;++i)(o=v[a[i]])&&(Me(s,l,r=f.fromLatLngToDivPixel(o.latlng)),l=r);if(s.stroke(),n)for(i=0;i<a.length;++i)(o=v[a[i]])&&Ee(o)}}function Me(e,t,n){var i,o,a,r,s,l=2*e.lineWidth,p=-l-C,d=L+l-C,g=-l-P,u=G+l-P;if(t.x>=p&&t.x<=d&&t.y>=g&&t.y<=u&&n.x>=p&&n.x<=d&&n.y>=g&&n.y<=u)return e.moveTo(t.x,t.y),void e.lineTo(n.x,n.y);if(t.x==n.x)return!(t.x<p||t.x>d)&&(i=a=t.x,o=Math.max(Math.min(t.y,n.y),g),r=Math.min(Math.max(t.y,n.y),u),e.moveTo(i,o),void e.lineTo(a,r));if(t.y==n.y){if(t.y<g||t.y>u)return;o=r=t.y,i=Math.max(Math.min(t.x,n.x),p),a=Math.min(Math.max(t.x,n.x),d),e.moveTo(i,o),e.lineTo(a,r)}if(n.x<t.x&&(s=n,n=t,t=s),!(t.x>d||n.x<p)){if(l=(n.y-t.y)/(n.x-t.x),s=n.y-l*n.x,t.x<p||t.y<g||t.y>u){if((o=l*(i=Math.max(t.x,p))+s)<g?i=((o=g)-s)/l:u<o&&(i=((o=u)-s)/l),i<p||d<i)return}else i=t.x,o=t.y;n.x>d||n.y<g||n.y>u?((r=l*(a=Math.min(n.x,d))+s)<g?a=((r=g)-s)/l:u<r&&(a=((r=u)-s)/l),(a<p||d<a)&&(console.log("oops!"),assert(!1))):(a=n.x,r=n.y),e.moveTo(i,o),e.lineTo(a,r)}}function ke(e,t,n,i){if(e.latlng&&n.containsLatLng(e.latlng)&&(e.disp||!i)&&e.img&&e.img.shape){n=f.fromLatLngToDivPixel(e.latlng),i=e.img,i=[i.top_offset,i.horiz_offset,i.bot_offset,i.horiz_offset];return e==b&&(i[w]+=4),t.x>=n.x-i[3]&&t.x<=n.x+i[1]&&t.y>=n.y-i[0]&&t.y<=n.y+i[2]}}function Le(e){for(var t,n,i,o=f.fromLatLngToDivPixel(e),a=new GPoint(o.x-D,o.y+B),e=new GPoint(o.x+D,o.y-B),r=new GLatLngBounds(f.fromDivPixelToLatLng(a),f.fromDivPixelToLatLng(e)),s=r.getSouthWest().lat(),l=r.getNorthEast().lat(),p=A.length-1;0<=p;--p)if((n=A[p]._meraki_node)&&ke(n,o,r,!1))return n;for(t=0,n=h.length;t<n;)h[p=t+(n-t>>1)].latlng.lat()<s?t=p+1:n=p;for(i=[],n=!d.hoverAny;t<h.length&&h[t].latlng.lat()<=l;++t)ke(h[t],o,r,n)&&i.push(h[t]);return i.sort(se),i.length?i[i.length-1]:void 0}function Ge(e){var t=e.xcanvas;t&&(t.style.visibility="hidden",t.getContext("2d").clearRect(0,0,t.width,t.height)),e.empty||(e.unbegin(),e.canvas.style.left=-C+"px",e.canvas.style.top=-P+"px",e.canvas.style.visibility="visible",e.xcanvas=e.canvas,e.canvas=t),e.empty=!0}function Ce(e,t){var n;(e||o)&&(n=++o,i=e),e&&setTimeout(function(){o==n&&(1e4<o&&(o=0),i=0,1==e?Pe(!1):2==e?ze():-1==e&&function(){var e,t,n,i,o,a;for(o=Te(),a=map3_bounds_expand(o,1.1),t=0;t<z.length;++t)if((n=z[t]).paused&&!n.disabled){if(n.backgrounder){if(!0===n.backgrounder.call(n,a,f,K))break}else{for(e=n.paused;e<_.length&&(i=_[e],!a.containsLatLng(i.latlng)&&!n.nobounds||!i.disp&&!n.nodisp||!0!==n.noder.call(n,i,a,f,K));++e);if(e<_.length-1){n.paused=e+1;break}}n.paused=!1,n.nobuf||Ge(n)}t<z.length?Ce(-1,75):Ce(0)}())},t)}function Pe(e){var t;if(0<i||!0===e&&W)Ce(1,n=Math.max(W?50:25,Math.min(2*n,200)));else{for(t=n=I=0;t<z.length;++t)z[t].count=0,z[t].paused=null,z[t].nobuf||re(z[t]),z[t].unbegin();y=[],ze()}}function Te(){var e=f.getBounds(),t=new GPoint(-C-D/2,-P+G+B);return e.extend(f.fromDivPixelToLatLng(t)),t=new GPoint(-C+L+D/2,-P),e.extend(f.fromDivPixelToLatLng(t)),e}function ze(){var e,t,n,i,o,a,r,s,l,p,d,g,u=f.getBounds().toSpan(),h=M*(L/u.lngRadians())*(G/u.latRadians()),c=h<800?0:1;if(c!==K.node_scalestep)for(e in K.node_scalestep=c,v)(n=v[e]).img=fe(n.n),n.highlight&&xe(n);for(a=map3_bounds_expand(u=Te(),1.1),(d=E.n).begin(),s=[],l=[],e=0;e<z.length;++e)(g=z[e]).disabled||(g.noder&&s.push(g),g.decorator&&l.push(g),g.backgrounder&&!1!==g.paused&&(g.paused=!0===g.backgrounder.call(g,a,f,K)));for(r=Math.max(50,_.length/25);I<_.length;++I)if(0!=(i=_[I]).latlng.lat()||0!=i.latlng.lng()){if(h=u.containsLatLng(i.latlng)){if(--r<=0)break;if(!i.img||!i.img.shape){N.push(i.img||!0);continue}o=f.fromLatLngToDivPixel(i.latlng),i.disp||p||(p=E.nbg).begin(),(t=i.disp?d:p).empty=!1,t.ctx.drawImage(i.img.image,o.x-i.img.horiz_offset,o.y-i.img.top_offset,i.img.image.width,i.img.image.height),y.push(i)}for(h=h||a.containsLatLng(i.latlng),t=0;t<l.length;++t)(h||l[t].nobounds)&&(i.disp||l[t].nodisp)&&l[t].decorator.call(l[t],i,a,i.disp?d:E.nbg,f,K);for(t=0;t<s.length;++t)!h&&!s[t].nobounds||!i.disp&&!s[t].nodisp||s[t].paused||!0===(c=s[t].noder.call(s[t],i,a,f,K))&&(s[t].paused=I+1)}if(I<_.length)Ce(2,10);else{for(h=!1,e=0;e<z.length;++e)z[e].nobuf||z[e].disabled||(z[e].paused?h=!0:Ge(z[e]));je(),Q=y,h?Ce(-1,75):Ce(0)}}function Ee(e){var t,n,i=E.route,o=e.highlight;if((o=!(o&&o.image&&o.gicon)?e.img:o)&&o.image&&o.gicon&&(0!=e.latlng.lat()||0!=e.latlng.lng()))for(t=f.fromLatLngToDivPixel(e.latlng),i.ctx.drawImage(o.image,t.x-o.horiz_offset,t.y-o.top_offset,o.image.width,o.image.height),n=0;n<z.length;++n)z[n].decorator&&!z[n].disabled&&z[n].decorator.call(z[n],e,null,i,f,K)}function je(){var e,t;if(S&&(clearTimeout(S),S=null),d.pinned&&(e=v[d.pinned.id],delete d.pinned,Se(e)),re(E.route),!Y&&(l||p||c)){for(E.route.begin(!0),l&&l!==p&&we(l,E.route,!1),p&&we(p,E.route,!0),t=A.length-1;0<=t;--t)!(e=A[t]).isHidden()&&e._meraki_node&&e._meraki_node!==l&&Ee(e._meraki_node);l&&Ee(l),E.route.show()}}function Ie(e){var t,n,i=e.n.gateway_route?e.n.gateway_route.split(" "):[];for(t in i)(n=v[i[t]])&&(delete n.in_pinned_route,xe(n));f.closeInfoWindow()}function Se(e,t){r=!0,function(e,t){var n,i,o,a;if(t&&e&&d.show3)e.disp||urlHash.pushState({n:e.id});else{if(t&&e&&X)return p&&(Ie(p),p=null,je()),checkbox3.toggle(e.n),xe(e);if(t&&!d.no_follow_click&&e&&p==e)window.location.href=url_for_node(e.id);else{for(n=p,p=e,t&&checkbox3.select(!1),o=A.length-1;0<=o;--o)(a=A[o]._meraki_node)&&xe(a);if(n&&Ie(n),e&&(t&&checkbox3.toggle(e.n,!0),xe(e)),e&&!d.show3)for(o in i=e.n.gateway_route?e.n.gateway_route.split(" "):[])(a=v[i[o]])&&(a.in_pinned_route=!0,xe(a));je()}}}(e,t),r=!1}function Ae(){var e,t;if(!r){for(e in v)!(t=v[e]).highlight!=!t.n.checked&&xe(t,!0);p&&Se(null,!1)}}function Oe(e,t){var n,i=!1,o=!1;if(t.id){if(delete F[t.id],t.delete)return void function(e){for(var t=0;t<_.length;++t)if(_[t].id===e){for(_[t].disp=!1,_.splice(t,1),t=0;t<h.length;++t)if(h[t].id===e){h.splice(t,1);break}K.refresh();break}}(t.id);if(!v[t.id])return}if(!(i=(t.tags||t["status#"])&&_e()?!0:i))for(n in R)if(t[n]){i=!0,o=o||1<R[n];break}o&&_e(),i&&K.refresh()}function Ne(a,r,e,s){var l=v,p=d;d.move_url&&T.ajax({type:"POST",url:set_uri_param(d.move_url,"move_version",(new Date).getTime()/1e3),contentType:"application/json",data:JSON.stringify(a),success:function(e){var t,n,i,o;if(e&&e.error){if(!r)return;a=r,s=function(){le(),K.refresh()}}else r&&(Z.push(r),0==(o=T(f.getContainer()).find("div.map3saveloc")).length&&((o=T("<div class='map3saveloc'><table class='table_map3saver'><tr><td class='td_map3saver'>Move saved.</td><td class='td_map3saver'><button class='b_map3saver undo'>Undo</button> &nbsp;<button class='b_map3saver ok'>OK</button></td></tr></table></div>")).appendTo(f.getContainer()),o.find("button.undo").bind("click",Re),o.find("button.ok").bind("click",function(){Z=[],GEvent.trigger(f,"meraki.move_done"),o.hide()})),o.show());for(t=0;t<a.length;++t)n=a[t],i=l[n.node_id||n.id],p.apply_serialized_move(i.n,n),i.latlng=p.locator(i.n);s&&s()}})}function Re(e){Ne(Z[Z.length-1],null,0,function(){le(),K.refresh(),Z.pop(),0==Z.length&&(GEvent.trigger(f,"meraki.move_done"),GEvent.trigger(f,"node_moved"),T("div.map3saveloc",f.getContainer()).remove())})}function De(e){for(var t,n=[],i=[],o=(e=!Array.isArray(e)?[e]:e).length-1;0<=o;--o)t=d.serialize_move(e[o]),n.push(t.save),i.push(t.undo);GEvent.trigger(f,"meraki.move_pending"),Ne(n,i,0,function(){GEvent.trigger(f,"node_moved")})}function Be(e){var t=d.prefs_key||"n."+Mkiconf.network_eid+"/map";json_select(Mkiconf.user_dashboard_prefs,t)===a&&setTimeout(save_user_dashboard_prefs,e,t)}function Qe(){var e;d.description_container&&(e=a.markers?"h"==a.markers?"Map of hops to gateway":Mkiconf.devices_noun_cap+" map":"Map of clients per "+Mkiconf.devices_noun,$j(f.getContainer()).is(":visible")&&T(d.description_container).html(e))}return K.prototype=new GOverlay,d=T.extend({serialize_move:function(e){return{save:{id:e.id,lat:e.latlng.lat(),lng:e.latlng.lng()},undo:{id:e.id,lat:e.n.lat,lng:e.n.lng}}},apply_serialized_move:function(e,t){e.lat=t.lat,e.lng=t.lng},move_url:Mkiconf.move_url,locator:function(e){return null!=e.lat&&null!=e.lng?new GLatLng(e.lat,e.lng):null}},d||{}),$.prototype.begin=function(e){return this.ctx||(this.canvas||ae(this),this.ctx=this.canvas.getContext("2d"),this.ctx.save(),this.ctx.translate(C,P)),e&&(this.empty=!1),this.ctx},$.prototype.unbegin=function(){this.ctx&&(this.ctx.restore(),this.ctx=null)},$.prototype.show=function(){!this.empty&&this.canvas&&(this.canvas.style.left=-C+"px",this.canvas.style.top=-P+"px",this.canvas.style.visibility="visible")},$.prototype.get_image=function(e){var t=O[e];return t||(t=new Image,(O[e]=t).onload=function(){me(t)},t.src=e.match(/^https?:/)?e:Mkiconf.images+e),t},$.prototype.node_marker_dimensions=function(e){var t={height:.4*e.img.image.height,width:.7*e.img.image.width,top_offset:e.img.top_offset};return"ptr"!=e.img.shape&&"pst"!=e.img.shape||(t.height=.3*e.img.image.height,t.width=.6*e.img.image.width,"ptr"==e.img.shape?t.top_offset=.8*e.img.top_offset:t.top_offset=.9*e.img.top_offset),t},$.prototype.node_label=function(e,t){var n,i,o,a,r,s,l,p,d,g,u,h,c=this.get_image("dingle-digits-z9.png");if(c.width||N.push(c),c.width&&e.img&&e.img.shape)for(t=t.toString().replace(/[^0-9]/g,""),n=c.width/10,i=c.height/2,o=c.width/10*t.length,r=this.node_marker_dimensions(e),s=Math.min(r.height/i,r.width/o),l=f.fromLatLngToDivPixel(e.latlng),p=1==e.img.color?i:0,d=l.x-e.img.horiz_offset+(e.img.image.width-o*s)/2,g=l.y-r.top_offset+(.8*e.img.image.height-i*s)/2,u=n*s,h=i*s,this.begin(!0),a=0;a<t.length;++a,d+=u)this.ctx.drawImage(c,n*(t.charCodeAt(a)-48),p,n,i-1,d,g,u,h)},$.prototype.node_image_label=function(e,t,n,i,o,a){var r,s,l,p;t.width||N.push(t),t.width&&e.img&&e.img.shape&&(2==arguments.length?(o=t.width,a=t.height):4==arguments.length&&(o=n,a=i),arguments.length<6&&(n=i=0),p=this.node_marker_dimensions(e),r=Math.min(1,1.3*p.height/a,1.3*p.width/o),l=(s=f.fromLatLngToDivPixel(e.latlng)).x-e.img.horiz_offset+(e.img.image.width-o*r)/2,p=s.y-p.top_offset+(.75*e.img.image.height-a*r)/2,this.begin(!0),this.ctx.drawImage(t,n,i,o,a,l,p,o*r,a*r))},K.add_layer=function(e){V(e),E.n&&K.refresh()},K.remove_layer=function(e){if("n"==e||"nbg"==e||"route"==e)throw new Error("special layer");for(var t=0;t<z.length;++t)if(z[t].name==e){z.splice(t,1);break}delete E[e],U(),E.n&&K.refresh()},K.reposition=function(){for(var e,t,n,i=0;i<arguments.length;++i)(e=v[arguments[i].id])&&(t=d.locator(e.n))&&(e.z=GOverlay.getZIndex(t.lat()),e.latlng=t,n=!0);n&&le()},K.displayed=function(e){var t,n=[];for(t in v)(v[t].disp||e)&&n.push(v[t].n);return n},K.clear_tooltip=function(){T("#nodemap_tooltip").fadeOut(200),clearTimeout(x),x=b=null},K.show_tooltip=function(e,t){var n,i=e?v[e.id||e]:null;i&&(n=f.getBounds().containsLatLng(i.latlng),e=0!=i.latlng.lat()||0!=i.latlng.lng(),n&&e||(i=null)),pe(i,!0),t&&Se(i,!1)},K.initialize=function(e){var t;if(L=f.getSize().width,G=f.getSize().height,V({name:"n",prio:20}),V({name:"nbg",prio:10,init:te}),V({name:"route",prio:100,nobuf:!0}),Mkiconf.has_wireless&&(V({name:"link",prio:0,setprefs:ne,init:ie,noder:oe,nobounds:d.show3,refreshers:["nbrs","curnbrs"],prefsmenu:function(e,t){return[{group:"Neighbors",name:"neighbors",value:"x",text:"No lines",prio:0},{group:"Neighbors",name:"neighbors",value:ee()?null:"d",text:"Dark lines",maptype_specific:!0},{group:"Neighbors",name:"neighbors",value:ee()?"l":null,text:"Light lines",maptype_specific:!0},{group:"Neighbors",name:"neighbors",value:"r",text:"Red lines",maptype_specific:!0}]}}),V({name:"producticon",prio:-1,sizer:function(e,t,n){return e+3},decorator:function(e,t,n,i,o){var a=n.get_image("node_icons/"+node_product_info(e.n,"icon","unknown")+"_all.png?4");n.node_image_label(e,a,0,88,26,22)},refreshers:["model","product_icon"],setprefs:function(e,t){this.disabled="p"!=t.markers},prefsmenu:{group:"Markers",name:"markers",value:"p",text:"AP type",pos:10}}),V({name:"clientcount",sizer:function(e,t,n){t=t["clients#"];return e+(t?t-1:-2)},decorator:function(e,t,n,i,o){e.n["clients#"]&&n.node_label(e,e.n["clients#"])},refreshers:["clients#"],setprefs:function(e,t){this.disabled=!!t.markers},prefsmenu:{group:"Markers",name:"markers",value:null,text:"Clients",pos:20}}),V({name:"hopcount",sizer:function(e,t,n){return(t.is_gateway||(t["gwhops#"]||0)<=2)&&t["status#"]<=2?e:e-1},decorator:function(e,t,n,i,o){!e.n.is_gateway&&e.n["gwhops#"]&&e.n["status#"]<=2&&n.node_label(e,e.n["gwhops#"])},refreshers:["is_gateway","gwhops#"],setprefs:function(e,t){this.disabled="h"!=t.markers},prefsmenu:{group:"Markers",name:"markers",value:"h",text:"Hops to gateway",pos:40}})),"undefined"!=typeof map3_layers)for(t=0;t<map3_layers.length;++t)V(map3_layers[t]);T("#nodemap_tooltip").bind("mouseover mouseout mousemove",ge),GEvent.addListener(f,"mousemove",function(e){Y||de(Le(e))}),GEvent.addListener(f,"mouseout",function(){ge({type:"mouseout"})}),GEvent.addListener(f,"movestart",function(){W=!0}),GEvent.addListener(f,"move",function(){b&&pe(b)}),GEvent.addListener(f,"moveend",function(){W=!1,1==i&&(n=0,K.redraw())}),GEvent.addListener(f,"dragend",ue),GEvent.addListener(f,"zoomend",ue),k=T(f.getContainer().firstChild.firstChild),J.push(GEvent.addDomListener(document,"keydown",he)),J.push(GEvent.addDomListener(document,"keyup",ce)),Qe()},K.redraw=function(e){var t,n,i;if(k&&!T(f.getContainer()).is(":hidden")){if(i=f.getZoom(),null!=q&&q!=i)for(j=0;j<z.length;++j)re(z[j],!0);if(q=i,t=f.getSize(),L=t.width,G=t.height,C=parseInt(k.css("left")),P=parseInt(k.css("top")),null==c)for(t in c=0,checkbox3.checked)(n=v[t])&&n.n.checked&&xe(n);Pe(!0)}},K.remove=function(){for(var e,t=0;t<z.length;++t)(e=z[t]).canvas&&e.canvas.parentNode.removeChild(e.canvas),e.xcanvas&&e.xcanvas.parentNode.removeChild(e.xcanvas),e.canvas=e.xcanvas=null;for(t=0;t<A.length;++t)A[t]._meraki_node&&delete A[t]._meraki_node.marker,delete A[t]._meraki_node,f.removeOverlay(A[t]);for(t=0;t<J.length;++t)GEvent.removeListener(J[t]);checkbox3.unbind(Ae),_=h=[],v={},A=[],O={},l=p=b=null,J=[],T("#nodemap_tooltip").hide(),T(document).unbind("node_change",Oe),Ce(0),N=[],clearTimeout(x),x=null,clearTimeout(H),H=null},K.refresh=function(e,t){var n,i,o,a,r,s;if(e){for(n in _)_[n].disp=!1;for(n in r=s=0,o=map3_bounds_expand(f.getBounds(),.94),a=new GLatLngBounds,e)(i=v[e[n].id])&&(0==i.latlng.lat()&&0==i.latlng.lng()||(i.disp=!0,++s,o.containsLatLng(i.latlng)&&++r,a.extend(i.latlng)));a.extend(new GLatLng(a.getNorthEast().lat()+B/G*o.toSpan().lat(),a.getNorthEast().lng())),n=Math.min(f.getBoundsZoomLevel(a),f.getCurrentMapType().getMaximumResolution()),!1===t||50<=r||(0<s&&0==r?n<=f.getZoom()?map3_set_center(f,a):f.panTo(a.getCenter()):r<s&&n+1==f.getZoom()?(f.zoomOut(),f.panTo(a.getCenter())):r<s&&n>=f.getZoom()&&map3_set_center(f,a,!0))}for(!l||l.disp||d.hoverAny||(t=l,l=void 0,xe(t)),p&&!p.disp&&Se(void 0),n=0;n<A.length;++n)!A[n].isHidden()&&A[n]._meraki_node&&A[n].setLatLng(A[n]._meraki_node.latlng);K.redraw(!0),Qe()},K.move_node=function(e,t){e=v[e.id];e&&(e.latlng=t,e.z=GOverlay.getZIndex(t.lat()),le(),De([e]),K.refresh())},K.num_visible=function(){return Q.length},K.blur=function(){K.clear_tooltip(),Se(null,!1)},checkbox3.bind(Ae),T(document).bind("node_change",Oe),K.get_prefsmenu=function(){for(var e,t,n=[{group:"Markers",name:"markers",value:"x",text:"Plain",pos:0,grouppos:-1}],i={"":1e4,Markers:-1},o=0;o<z.length;++o)for((t="function"==typeof(t=z[o].prefsmenu)?t(K,a):t)&&null==t.length&&(t=[t]),e=0;e<(t||[]).length;++e)i.hasOwnProperty(t[e].group||"")||(i[t[e].group]=null==t[e].prio?n.length:t[e].prio),n.push(T.extend({pos:n.length,grouppos:i[t[e].group||""]},t[e]));for(n.sort(function(e,t){return e.grouppos-t.grouppos||strcmp(e.name,t.name)||e.pos-t.pos}),o=0;o<n.length;){for(e=o+1;e<n.length&&n[e].name==n[o].name;++e);e==o+1&&"radio"==(n[o].type||"radio")?n.splice(o,1):o=e}return n},K.change_prefs=function(){var e;if(0<_.length){for(e=0;e<z.length;++e)(z[e].setprefs||z[e].init)&&ae(z[e]);U(),K.refresh()}else Qe();Be(300)},K.enter=Qe,K.set_pinned_node=function(e){d.pinned=e,m=v[e.id],Se(m)},K.canvas_offset=function(){return{left:C,top:P}},function(e,t){var n,i,o,a,r,s;for(n in _=[],h=[],v={},a=null==t,s=d.locator,e)r=s(i=e[n]),null!=i["status#"]&&r&&(o={id:i.id,n:i,z:GOverlay.getZIndex(r.lat()),latlng:r,disp:a},_.push(o),h.push(o),v[n]=o);for(n in t||{})(o=v[t[n].id])&&(o.disp=!0);le()}(e,d.displayed),f.addOverlay(K),GEvent.addListener(f,"click",function(e,t,n){e||Se(null,!0)}),K}function Map3RecenterGMapControl(e){this.map3=e}function Map3PrefsGMapControl(e,t){this.map3=e,this.prefs=t}function make_map3(d,g){var u,h,c,f,m,r,e,t,n,a={},s=0,i="gmap",o=[];function l(e,t,n,i){a&&(!a[e]&&n&&(a[e]={c:n,dd:t,p:i}),(i=a[e])&&(t&&!i.d?(u.addControl(i.c,i.p),"overview"===e&&i.c.hide(!0)):!t&&i.d&&(u.removeControl(i.c),"dragzoom"===e&&i.c.remove()),null!=(i.d=t)&&(i.dd=t)))}function p(){var e,t,n,i=0,o=new GOverviewMapControl;for(e in GOverviewMapControl.prototype)++i;if(0<s&&(30<i||50<=s)){n=a.overview&&a.overview.d,l("overview",t=!map3_type_is_custom(u)&&!d.minimal_controls,o),t&&!n&&l("map_type",!1),!a||a.map_type&&a.map_type.d||l("map_type",!0,new GMenuMapTypeControl);try{$j(a.map_type.c.A).css("z-index","10")}catch(e){}}else++s,setTimeout(p,100)}function _(e){var t,n,i,o,a,r,s=map3_type_is_custom(u),l=s?"."+c.get_map_type():"";if(!e||!m){if(m=!0,null==f["lat"+l]||null==f["lng"+l]||null==f["zoom"+l]||g.show3)if(s&&h)h.recenter();else{if(t=new GLatLngBounds,o=0,g.show3)for(r=g.displayed,n=0;r&&n<r.length;++n)o+=p(r[n]);if(o||(r=nodes_hash,jQuery.each(nodes_hash,function(e,t){0==t.lat&&0==t.lng||(o+=p(t))})),!o)for(m=!1,n=(a=d.bounds||[]).length-1;0<=n;--n)i=new GLatLng(a[n][0],a[n][1]),t.extend(i);map3_set_center(u,t)}else u.setCenter(new GLatLng(f["lat"+l],f["lng"+l]),f["zoom"+l]);u.savePosition()}function p(e){return null!=e.lat&&null!=e.lng?(i=new GLatLng(e.lat,e.lng),t.extend(i),1):0}}function v(){var e=jQuery.extend({},g,h?h.map_overlay_options():{},{});e.displayed||"undefined"!=typeof search_filter&&(e.displayed=search_filter.results),r&&u.removeOverlay(r),r=make_map3_overlay(u,nodes_hash,e,f),y()}function y(){var e;(e=jQuery("#custom_maps_empty_message")).length&&e.toggle(!!(h&&h.get_current_map()&&r&&0==r.displayed(!0).length))}function b(e,t){var n,i,o=u.getMapTypes(),a=r;for(t&&h&&(o=h.filter_types_to_display(o,r.displayed())),e=e||u.getCurrentMapType().getName(!0),i=o[0],n=0;n<o.length;++n)if(o[n].getName(!1)==e||o[n].getName(!0)==e){i=o[n];break}return i&&(a.map_type_changing=!0,u.setMapType(i),delete a.map_type_changing),u.getCurrentMapType()}function x(){f.type=u.getCurrentMapType().getName(!0),"Map"==f.type&&(f.type=null),r.change_prefs(),a.dopts&&a.dopts.c&&a.dopts.c.blur()}function w(e){e!==i&&(i=e,p(),l("scale","gmap"==i||"floorplan_scale"==i))}return d=jQuery.extend({},"object"==typeof map3_settings?map3_settings:{},d),e=d.prefs_key||"n."+Mkiconf.network_eid+"/map",n=(t="user_dashboard_prefs")+"_saved",Mkiconf[t]=json_ensure(Mkiconf[t],e),Mkiconf[n]=json_ensure(Mkiconf[n],e),f=json_select(Mkiconf[t],e),d.user_prefs||(f=jQuery.extend(!0,{},f),g.show3&&(f.markers="x")),c={get_gmap:function(){return u},map_name:function(){return u.getCurrentMapType().getName(!0)},is_custom:function(){return map3_type_is_custom(u)},node_is_placed:function(e){return c.is_custom()?!!custom_map_placements.find(c.map_name(),e):0!=e.lat&&0!=e.lng},recenter:_,blur:function(){r&&r.blur(),a&&a.dopts&&a.dopts.c&&a.dopts.c.blur()},show_tooltip:function(){r&&r.show_tooltip.apply(-1,arguments)},refresh:function(){r&&r.refresh.apply(-1,arguments)},reposition:function(){r&&r.reposition.apply(-1,arguments)},num_visible:function(){return r?r.num_visible.apply(-1,arguments):0},get_prefsmenu:function(){return r?r.get_prefsmenu.apply(-1,arguments):{}},change_prefs:function(){return r?r.change_prefs.apply(-1,arguments):void 0},enter:function(e){u&&u.checkResize(),e&&b(e),r&&r.enter(),y()},destroy:function(){var e;for(r&&u.removeOverlay(r),h&&(h.stop(),custom_map_placements.unbind(v)),e=(o?o.length:0)-1;0<=e;--e)GEvent.removeListener(o[e]);r=h=o=a=c=null,jQuery(d.map_el).empty()},rebuild_overlay:v,control:l,hide_controls:function(){for(var e in a||{})l(e,null)},show_controls:function(){for(var e in a||{})l(e,a[e].dd)},get_map_type:function(){return u.getCurrentMapType().getName()},set_map_type:b,set_pinned_node:function(e){return r?r.set_pinned_node(e):void 0},move_node:function(e,t){return r.move_node(e,t)}},googleMapsLoad(function e(){var t,n=jQuery(d.map_el);GBrowserIsCompatible()?n.width()<=0||n.height()<=0?setTimeout(e,10):((u=new GMap2(n[0])).addMapType(G_PHYSICAL_MAP),new GKeyboardHandler(u),null==f.lat&&null==f.lng&&null==f.zoom&&(f.lat=d.lat,f.lng=d.lng,f.zoom=d.zoom),_(),v(),n=GEvent.addListener(u,"maptypechanged",x),o.push(n),n=GEvent.addListener(u,"meraki.maptype",w),o.push(n),l("small_nav",!!d.minimal_controls,new GSmallZoomControl),l("large_nav",!d.minimal_controls,new GLargeMapControl),Map3RecenterGMapControl.hasOwnProperty("prepare")&&Map3RecenterGMapControl.prepare(),l("recenter",!!d.minimal_controls,new Map3RecenterGMapControl(c),new GControlPosition(G_ANCHOR_TOP_LEFT,new GSize(7,43))),p(),l("dragzoom",!d.minimal_controls,make_DragZoomControl({},{backButtonEnabled:!0,buttonStartingStyle:{display:"inline"},buttonHTML:'<img src="'+Mkiconf.images+'zoom-button.gif" alt="Zoom" title="Zoom to region" />',backButtonHTML:'<img src="'+Mkiconf.images+'zoom-button-out.gif" alt="Zoom out" title="Zoom back" />',buttonZoomingHTML:'<img src="'+Mkiconf.images+'zoom-button-activated.gif" alt="Zooming" />'},{}),new GControlPosition(G_ANCHOR_TOP_LEFT,new GSize(80,7))),l("scale",!0,new GScaleControl),Map3PrefsGMapControl.hasOwnProperty("prepare")&&Map3PrefsGMapControl.prepare(),l("dopts",Mkiconf.has_wireless&&!d.minimal_controls,new Map3PrefsGMapControl(c,f)),"undefined"!=typeof make_custom_map_manager&&(d.check_type_display&&(t=r.displayed()),h=make_custom_map_manager(c,t),custom_map_placements.bind(v)),b(f.type||"Map",d.check_type_display)):alert("Sorry, the Google Maps API is not compatible with this browser")}),c}function map3_bounds_expand(e,t){var n=e.getCenter(),i=e.toSpan(),e=new GLatLngBounds(e.getSouthWest(),e.getNorthEast());return t*=.5,e.extend(new GLatLng(n.lat()-i.lat()*t,n.lng()-i.lng()*t)),e.extend(new GLatLng(n.lat()+i.lat()*t,n.lng()+i.lng()*t)),e}function map3_type_is_custom(e){e=e.getCurrentMapType();return e!==G_NORMAL_MAP&&e!==G_SATELLITE_MAP&&e!==G_HYBRID_MAP&&e!==G_PHYSICAL_MAP}Map3RecenterGMapControl.prepare=function(){Map3RecenterGMapControl.prototype.getDefaultPosition=function(){return new GControlPosition(G_ANCHOR_TOP_LEFT,new GSize(7,7))},Map3RecenterGMapControl._applyButtonStyle=function(e){img_src=Mkiconf.images+"recenter_mini.png",e.src=img_src,e.style.padding="0px",e.style.margin="0px",e.style.width="17px",e.style.height="17px",e.style.cursor="pointer"},Map3RecenterGMapControl.prototype=new GControl,Map3RecenterGMapControl.prototype.initialize=function(e){var t=document.createElement("div"),n=(document.createElement("img"),document.createElement("img"));Map3RecenterGMapControl._applyButtonStyle(n),t.appendChild(n);var i=this.map3;return GEvent.addDomListener(t,"click",function(){i.recenter()}),e.getContainer().appendChild(t),t}},Map3PrefsGMapControl.prepare=function(){Map3PrefsGMapControl.sequencer=1,Map3PrefsGMapControl.prototype=new GControl,Map3PrefsGMapControl.prototype.initialize=function(e){var t=jQuery("<div class='gmap_button' style='width: 83px'><div class='gmap_button0'><div class='gmap_button1'><div class='gmap_button2'>Options<div class='gmap_menu_pointer'></div></div></div></div></div>"),n=this;return t.mousedown(function(){n.prefform?n.blur():(n._render_prefsmenu(n.map3.get_prefsmenu()),jQuery(n.button).addClass("gmap_buttondown"))}),e.getContainer().appendChild(t[0]),this.button=t[0]},Map3PrefsGMapControl.prototype.blur=function(){this.prefform&&(jQuery(this.prefform).remove(),this.prefform=null,jQuery(this.button).removeClass("gmap_buttondown"),jQuery("body").unbind("click",this.blurprefform),this.blurprefform=null)},Map3PrefsGMapControl.prototype.getDefaultPosition=function(){return new GControlPosition(G_ANCHOR_TOP_RIGHT,new GSize(7,32))},Map3PrefsGMapControl.prototype._make_prefsmenu_clicker=function(){var i=this;return function(e){var t,n;(t=this.name)&&(n=""==this.value&&"checkbox"==this.type?this.checked?null:"1":this.checked&&this.value||null,jQuery(this).hasClass("maptype_specific")?(i.prefs[t]=null,i.prefs[t+"."+(i.prefs.type||"Map")]=n):i.prefs[t]=n,i.map3.change_prefs()),e.stopPropagation()}},Map3PrefsGMapControl.prototype._prefsmenu_div_clicker=function(){jQuery(this).find("input")[0].click()},Map3PrefsGMapControl.prototype._render_prefsmenu=function(e){var t,n,i,o,a,r,s=[],l=jQuery(this.button).offset();for(s.push("<div style='position: absolute; visibility: hidden; top: "+(l.top+jQuery(this.button).outerHeight()-1)+"px; z-index: 1000;'><div class='dmenuctr map3pref'><div class='dmenuctr1'>"),i=Map3PrefsGMapControl.sequencer++,l=0;l<e.length;++l)!(n=e[l]).group||0!=l&&n.group==e[l-1].group||s.push('<h3 class="'+(0==l?"dmenu_first":"dmenu")+'">'+n.group+"</h3>\n"),a=n.name,s.push('<div class="dmenuitem"><input id="'+(o="map3pref_"+i+"_"+l)+'" name="'+a+'" value="'+(n.value||"")+'"'),"checkbox"==n.type?s.push(' type="checkbox"'):s.push(' type="radio"'),s.push(' class="dmenu'),n.maptype_specific&&(s.push(" maptype_specific"),a+="."+(this.prefs.type||"Map")),this.prefs[a]==n.value&&s.push('" checked="checked'),s.push('" />&nbsp;<label for="'+o+'">'+n.text+"</label></div>");s.push("</div></div></div>"),(t=jQuery(s.join(""))).find("input, label").click(this._make_prefsmenu_clicker()),t.find("div.dmenuitem").click(this._prefsmenu_div_clicker),jQuery("body")[0].appendChild(t[0]),position_horizontally_in_viewport(t,jQuery(this.button)),t.css({visibility:"visible"}).click(function(e){e.stopPropagation()}),this.blurprefform=(r=this,function(){r.blur()}),jQuery("body").click(this.blurprefform),this.prefform=t},delete Map3PrefsGMapControl.prepare},map3_set_center=function(){var c=0,f=[];return function(e,t,n){var i,o,a,r,s,l;function p(e,t,n,i){return t<i?n:e-t/2<=n-i/2&&n+i/2<=e+t/2?e:n-i/2<e-t/2?n-i/2+t/2:n+i/2-t/2}if(++c,n)(i=e.getBounds()).containsBounds(t)||(n=i.getCenter(),d=i.toSpan(),g=t.getCenter(),u=t.toSpan(),u=new GLatLng(u.lat()+.08*d.lat(),u.lng()+.08*d.lng()),e.setCenter(new GLatLng(p(n.lat(),d.lat(),g.lat(),1.2*u.lat()),p(n.lng(),d.lng(),g.lng(),1.2*u.lng())),e.getZoom()));else{var d=Mkiconf.has_wireless?16:13,g=(t=map3_bounds_expand(t,1.08)).getCenter(),u=e.getCurrentMapType(),h=Math.min(e.getBoundsZoomLevel(t),u.getMaximumResolution(),d);if(u!=G_SATELLITE_MAP&&u!=G_HYBRID_MAP||!u.getMaxZoomAtLatLng)e.setCenter(g,h);else{for(o=0;o<f.length;++o)if(f[o].latlng.distanceFrom(g)<=1e4){h=Math.min(f[o].zoom,h);break}e.setCenter(g,h),o>=f.length&&u.getMaxZoomAtLatLng(g,(a=e,r=g,s=h,l=c,function(e){"zoom"in e&&(f.push({latlng:r,zoom:e.zoom}),c==l&&a.getCenter().equals(r)&&e.zoom<s&&a.setCenter(r,e.zoom))}))}}}}();