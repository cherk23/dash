/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
var show3_client=function(u){var g,e,i,s=0,o=1,a=2,r=3;function m(){return u("#clientedit"+g)}function h(e,n,t,i){n?i?e.html(n):e.html(html_entity_encode(n,!0)):e.html('<span class="deftext">'+(t||"None")+"</span>")}function c(){var e,t,n,i,s,o,a,r,c,l=m(),d=Mkijson.c.hash[g],_=u("#clientinfo"+g),p=client3_access_status(d),f=null!=d.client_vpn_details;f?h(u(".s3name"),d.description||d.mdns_name||d.netbios||d.client_vpn_details.user,"(unknown)"):h(u(".s3name"),d.description||d.mdns_name||d.netbios,d.mac||"(unknown)"),_.find(".s3tr_notes").toggle(!!d.notes),h(_.find(".s3tr_notes > .s3x"),d.notes),h(_.find(".s3access"),client3_render_access_status(d),null,!0),h(u("#recent_bigacl_state"),client3_render_bigacl_status(d,g,u("#recent_bigacl_state").closest("tr")),null,!0),u(".bigacledit-"+g+"-revoke").each(function(){u(this).click(function(e){e.preventDefault(),u(this).parent().parent().fadeTo("slow",.6),u(this).parent().html("revoke authorization"),u.ajax({url:Mkiconf.bigacl_revoke_url,type:"POST",dataType:"json",data:{ssid:u(this).attr("ssid"),wired_vlan:u(this).attr("wired_vlan"),auth_reason:u(this).attr("reason")},error:k,success:b})})}),_.find(".s3tr_blockmsg").toggle(!!(p<0&&d.blockmsg)),h(_.find(".s3tr_blockmsg > .s3x"),d.blockmsg),"wired"!=Mkiconf.network_type||f?(_.find(".s3tr_port_forwarding").hide(),_.find(".s3tr_one_to_one").hide()):((e=d.port_forwarding_settings&&0<d.port_forwarding_settings.length)?(t=u("<div/>"),c="",jQuery.each(d.port_forwarding_settings,function(e,n){"wired"==Mkiconf.network_type&&Mkiconf.public_contact_point?(t.append(c),t.append(bootstrap.make_dropdown_widget({title:"Public port "+n.public_port+"&nbsp;",klass:"inline dim subtle low-margin-and-padding",content:"This port is reachable at the following contact point: <input value='"+Mkiconf.public_contact_point+":"+n.public_port+"' size='60' />",caret_class:"fa fa-link"}))):t.append(c+"Public port "+n.public_port+" "),t.append("&rarr; Local port "+n.local_port),n.name&&t.append(" ("+n.name+")"),c="<br/>"}),_.find(".s3tr_port_forwarding > .s3x").html(t)):_.find(".s3tr_port_forwarding > .s3x").html('<span class="deftext">None</span>'),s=_,a="",(o=d).one_to_one_nat_settings&&0<o.one_to_one_nat_settings.length?jQuery.each(o.one_to_one_nat_settings,function(e,n){a+=(a?", ":"")+n.wanip+" ("+n.name+")"}):a="<span class='deftext'>None</span>",s.find(".s3tr_one_to_one > .s3x").html(a),n=_.find(".s3tr_ip"),i=_.find(".s3tr_ip > .s3l"),p=_.find(".s3tr_assigned_ip"),d.assigned_ip?(o=_.find(".s3tr_ip > .s3x").html(),s=d.assigned_ip,d.assigned_ip!=o?(i.html("Last seen IP:"),n.toggle(!0),o=[],e&&o.push("forwarded ports"),d.one_to_one_nat_settings&&0<d.one_to_one_nat_settings.length&&o.push("one to one IPs"),0<o.length&&(s+=" (The "+o.join(" and ")+" will use this assigned IP.)")):(n.toggle(!1),s+=" (fixed)"),_.find(".s3tr_assigned_ip > .s3x").html(s),p.toggle(!0)):(i.html("IP:"),n.toggle(!0),p.toggle(!1))),f&&(c=r="",jQuery.each(d.client_vpn_details.connections,function(e,n){r+=c+"From "+n.remote_ip+" as local IP "+n.local_ip+"<br/><span style='padding-left:2em'>",n.disconnected_at_str?r+="connected from "+n.connected_at_str+" to "+n.disconnected_at_str:r+="connected since "+n.connected_at_str,r+="</span>",c="<br/>"}),h(u("#client_vpn_connections"),r,null,!0)),l.hide(),_.show()}function l(){var e,n,t,i,s,o=m(),a=Mkijson.c.hash[g],r=u("#clientinfo"+g),c=client3_access_status(a);switch(o.find("input[name=description]").val(a.description||a.mdns_name||a.netbios||"").parent(),o.find("textarea[name=notes]").val(a.notes||""),(_=o.find(".s3blocked")).toggle(1==c),_.find(".s3blocked_nodevmsg").toggle(!a.blockmsg),_.find(".s3blocked_hasdevmsg").toggle(!!a.blockmsg),e=o.find("input[name=access]"),n=o.find("#client_policy_c .context"),c){case Mkiconf.bigacl_group_num_none:e.filter("*[value=normal]").prop("checked",!0);break;case Mkiconf.bigacl_group_num_whitelist:e.filter("*[value=whitelisted]").prop("checked",!0);break;case Mkiconf.bigacl_group_num_blocked:e.filter("*[value=blocked]").prop("checked",!0);break;case"group_policy":e.filter("*[value=group_policy]").prop("checked",!0),(t=n.filter(".group_policy").find("SELECT")).val(a.access_policy.network);break;case"ssid_policy_map":for(ssid in e.filter("*[value=ssid_policy_map]").prop("checked",!0),t=n.filter(".ssid_policy_map").find("SELECT:not(.group_policies)"),a.access_policy.ssid)i=a.access_policy.ssid[ssid],s="client_device_access_policy[ssid]["+ssid.toString()+"]",u(t.filter("[name='"+s+"']")).val(i)}e.filter(":checked").triggerHandler("click"),o.find("textarea[name=blockmsg]").val(a.blockmsg||""),o.find(".errf").removeClass("errf"),o.find(".bad").hide();var l=u("#policy_tool");u("#client_policy_c").unbind().bind("click",function(e){var n=m(),t=(Mkijson.c.hash[g],u(e.target)),n=n.find(["#client_policy_c .context.ssid_policy_map",".chosen_wrapper SELECT"].join(" ")),i=l.find("SELECT.group_policies").val();if(t.is("A.target"))return n.each(function(e,n){t.is("A.preview_all_ssids")&&u(n).val(i.toString()).trigger("chosen:updated")}),e.stopPropagation(),!1});var d=$j("#port_forwarding_status_"+g),_=$j("#one_to_one_status_"+g);0<d.length&&(c=[{classname:"name",headername:"Name",type:"inputtext",size:20},{classname:"proto",headername:"Protocol",type:"inputselect",options:[["TCP","tcp"],["UDP","udp"]]},{classname:"public_port",headername:"Public port",type:"inputnumeric",size:10},{classname:"local_port",headername:"Local port",type:"inputnumeric",size:10}],Mkiconf.has_new_forwarding_firewall&&c.push({classname:"allowed_ips",headername:"Allowed remote IPs",type:"inputtextarray",cols:16}),c.push({classname:"",headername:"Actions",type:"actions"}),d.empty().flex_editor({columns:c,add_text:"Add a port",orderable:!1,prefix:"port_forwarding_settings",no_entries_message:"There are no port forwarding rules for this client.",hide_headers_when_empty:!0,rows:a.port_forwarding_settings||[]})),0<_.length&&_.empty().flex_editor({columns:[{classname:"one_to_one_mapping",type:"dom",custom_cell_dom:$j("#one_to_one_skeleton"),init:one_to_one_init,to_obj:one_to_one_to_obj},{classname:"",type:"actions"}],add_text:"Add a 1:1 NAT mapping",orderable:!0,prefix:"one_to_one_nat_settings",no_entries_message:"There are no 1:1 NAT mappings for this client.",no_classname_data:!0,class:"divider",no_header:!0,renumbering_callback:Mkiconf.has_new_forwarding_firewall?function(e,n){jQuery(e).data("firewall_flex_editor").set_prefix("one_to_one_nat_settings["+n+"][allowed_inbound]")}:null,rows:a.one_to_one_nat_settings||[]}),r.hide(),o.show()}function d(e){var n=m(),t=(Mkijson.c.hash[g],e==a||e==r);n.stop().css("opacity",1).find(":submit, :reset").attr("disabled",!1),Mkiconf.can_write||n.find(":submit").attr("disabled","disabled"),i=i||make_change_tracker({selector:n,nobox:1,highlight:n.find(".s3actions > div")}),e==a&&l(),e!=r&&i.reset(),u("#clientedit"+g+"_editb").attr("disabled",t&&"disabled"),e!=o&&e!=s||c()}function b(e,n){var t=m();t.find(".errf").removeClass("errf"),e.clients&&(data3_load(e),Mkijson.c.flex_table&&Mkijson.c.flex_table.render(),c(),d(o)),t.trigger("submit_success"),change_tracker.reset()}function k(e,n,t){var i,s=m(),o=xhr_extract_error_json(e);if(s.find(".errf").removeClass("errf"),o.errf){for(i=0;i<o.errf.length;++i)("access"==o.errf[i]?s.find(".s3access"):s.find(":input[name="+o.errf[i]+"]")).addClass("errf");s.find(".bad").html(o.error||"").show(),d(r)}s.trigger("submit_error.configurejs")}function t(){var t=m();t.submit(function(){var e,n;return t.find(":submit, :reset").attr("disabled","disabled"),e=m(),n=e.serialize(),Mkijson.c.hash[g],e.fadeTo("slow",.6),u.ajax({url:e.attr("action"),type:"POST",dataType:"json",data:n,error:k,success:b}),!1}),t.find(":reset").click(function(){d(s)}),0===t.find(".context.group_policy SELECT OPTION").length&&t.find(".context.group_policy").parents("TR").first().find(":input").attr("disabled","disabled"),t.find("input[name=access]").unbind().click(function(e){var n=$j(e.target),t=m(),e=n.parents("TR").first(),n=t.find("input[name=access]:checked").val();e.hasClass("selected")||(t.find(".selected").removeClass("selected").find(".context").slideUp("fast"),e.addClass("selected"),e.find(".context").slideDown("fast")),t.find(".s3blocked")["blocked"==n?"slideDown":"slideUp"]("fast")}),u("#clientedit"+g+"_editb").click(function(){return d(a),m().find("input[name=description]").focus(),jQuery(window).trigger("resize"),!1})}function _(){graph_client_use("#transferreds_graph_canvas_"+g,g)}return(e=function(e){var n=Mkijson.c.hash[e.id]||{};u=u||window.jQuery,g=e.id,t(),_(),d(o);e={C:g,M:n.mac};Mkiconf.has_wireless||(e.L=n["last_seen_by#"]),mki_live_tests.initialize(e),u(window).trigger("mki_live_tests_init"),u(window).bind("resize."+g,function(){var e=u("#transferreds_graph_canvas_"+g),n=e.parent().width();n!=e.width()&&(e.empty().width(n),_())})}).current_client_id=function(){return g},e.confirm_stop=function(){return!i||i.confirm()},e.stop=function(){i&&i.kill(),mki_live_tests.cleanup(),u(window).unbind("."+g),g=i=null},e}(window.jQuery);