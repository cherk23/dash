/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(){var r=["input","textarea","select","img"],e=doT.template('{{~ it :value}}<i class="fa fa-{{! value[0] }}" title="{{! value[1] }}" />{{~}}'),o=Backbone.Model.extend({sync:$.noop}),i=Backbone.Epoxy.View.extend({tagName:"tr",bindings:{},events:{"click :not(:disabled) .fa-remove":"destroy",drop:"drop"},initialize:function(){this.$el.html(this.template)},destroy:function(){this.model.destroy()},drop:function(){var t=this.model;t.collection.remove(t,{silent:!0}).add(t,{at:this.$el.index(),silent:!0}).trigger("change")}});window.MKI.Views.FlexEditorRow=i,window.MKI.Views.FlexEditor=Backbone.Epoxy.View.extend({tagName:"table",defaults:{initialColumns:[],selectedColumns:[],addText:"Add"},bindings:{tbody:"collection:$collection"},events:{},initialize:function(){var e=this;_.bindAll(this,"computeRowBindings","computeTemplate","columnNames","renderHeader","renderAddButton","computeActions","initMovable","initSortable","doSort"),_.defaults(this.options,{columns:this.columns,sortable:this.sortable,defaultSort:this.defaultSort,itemView:this.itemView,isFlexTable:this.isFlexTable,remove:this.remove,editable:this.editable,movable:this.movable,initialColumns:this.initialColumns,selectedColumns:this.selectedColumns},this.defaults),this.collection instanceof Backbone.Collection||(this.collection=new Backbone.Collection(this.collection,{model:o})),this.deletions=new Backbone.Collection([],{model:o}),this.collection.on("remove",function(t){t.isNew()||e.deletions.create(t)}),this.columns=this.options.columns;var t=this.options.itemView;(t=!t||t===i?i.extend({}):t).constructor===i.constructor&&(t.prototype.viewModel||(t.prototype.viewModel=new Backbone.Epoxy.Model({})),this.viewModel=t.prototype.viewModel,t.prototype.template||(t.prototype.template=this.computeTemplate(),_.extend(t.prototype.bindings,this.computeRowBindings()))),this.itemView=t,(this.options.sortable||_.findWhere(this.columns,{sortable:!0}))&&this.initSortable(this.options.defaultSort),this.options.isFlexTable&&this.$el.addClass("filter compact fill"),this.renderHeader().renderBody()},computeRowBindings:function(){var l=this,a={};return _.each(this.columnNames(),function(t){var o,i,e,s,n=l.columns[t];n.bindings?(o={},i="td."+t+" ",_.each(n.bindings,function(t,e){o[i+e]=t}),_.extend(a,o)):(e="td."+t+" "+(_.contains(r,n.type)?n.type:""),"img"==n.type?a[e]="attr:{src:"+(n.computed||t)+"}":(s=_.contains(r,n.type)?"value":n.type||"text",a[e]=s+":"+(n.computed||t)),"select"===n.type&&(l.viewModel.set(t=t+"Options",n.selectOptions),a[e]+=",options:"+t)),n.resources&&_.each(n.resources,function(t,e){l.viewModel.set(e,t)})}),a},computeTemplate:function(){var o=this,i=$("<tr/>");return _.each(o.columnNames(),function(t){var e=o.columns[t],t=t;e.className&&(t+=" "+e.className);t=$("<td/>",{class:t});e.template?t.append(e.template):_.contains(r,e.type)&&t.append($("<"+e.type+"/>",e.inputAttrs)),i.append(t)}),o.options.isFlexTable&&i.children("td").addClass("ft"),i.html()+o.computeActions()},computeActions:function(){var t=[];return this.options.movable&&(this.initMovable(),t.push(["arrows","Reorder"])),this.options.remove&&t.push(["remove","Delete"]),this.options.editable&&t.push(["pencil","Edit"]),_.isEmpty(t)?"":"<td class='actions'><div>"+e(t)+"</div></td>"},columnNames:function(){return this.options.initialColumns.concat(this.options.selectedColumns)},renderHeader:function(){var o=this,t=o.$el.children("thead");t.is("*")||(o.$thead=t=$("<thead />"),o.$el.append(t));var e,i=$("<tr/>").appendTo(t);return _.each(o.columnNames(),function(t){var e=$("<th/>").text(o.columns[t].label).attr("data-column",t).appendTo(i);return(o.options.sortable&&!1!==o.columns[t].sortable||!0===o.columns[t].sortable)&&e.addClass("sortable"),e}),(o.options.sortable||_.findWhere(o.columns,{sortable:!0}))&&(e=i.children("th.sortable"),_.each(["up","down"],function(t){t=$("<img/>",{class:t,src:Mkiconf.images+"icon_arrow_"+t+"_10x10.png"}).hide();e.append(t)})),_.any(this.computeActions())&&$("<th/>").addClass("actions").appendTo(i),t.append(i),o.options.isFlexTable&&t.children("tr").addClass("ft_head").children("th").addClass("ft ftl"),o},renderBody:function(){var t=this.$el.children("tbody");return t.is("*")||(this.$tbody=t=$("<tbody />",{class:"flex-editor-body"}),this.$el.append(t)),this},renderAddButton:function(){var t=this;if(!t.$addButton)return t.$addButton=$("<button class='btn btn-default add' type='button'>"+(t.options.addText||t.defaults.addText)+"</button>").click(function(){t.collection.add(t.options.defaultModel||{})}),t.$addButton},initMovable:function(){this.$el.sortable({handle:".fa fa-arrows",items:" > tbody > tr",opacity:.5,axis:"y",cancel:".flex-editor:disabled",update:function(t,e){e.item.trigger("drop")}})},initSortable:function(t){function e(t,e){return t=t.get(this._sort_by),e=e.get(this._sort_by),t<e?-1:e<t?1:0}var o=this.columns;_.extend(this.collection,{comparator:function(t,e){return this._sort_func.apply(this,[t,e])*(this._sort_reverse?-1:1)},sort_by:function(t){t==this._sort_by?this._sort_reverse=!this._sort_reverse:t&&(this._sort_by=t,this._sort_reverse=!1,o[t]&&o[t].comparator?this._sort_func=o[t].comparator:this._sort_func=e),this.sort()},sort_direction:function(){return this._sort_reverse?"desc":"asc"},_sort_by:null,_sort_reverse:!1,_sort_func:e}),t&&this.collection.sort_by(t),this.events["click th.sortable"]="doSort"},doSort:function(t){var e;this.$thead.find("th img").hide(),_.isString(t)?e=this.$thead.find('th[data-column="'+(o=t)+'"]'):o=(e=$(t.target).closest("th")).data("column"),this.collection.sort_by(o);var o="asc"==this.collection.sort_direction()?"down":"up";e.children("img."+o).show()}})}();