/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
window.nmAddon=window.nmAddon||{},function(Je){var Ke,$e,Qe,Xe,et="rgba(10,10,230,0.2)",tt={n:"rgba(255, 105,180, 0.6)",s:"rgba(100, 149, 237, 0.6)"},ot="rgba(10,230,10,0.8)",nt="rgba(10,230,10,0.2)",at={l:"rgba(210,219,220,0.32)",d:"rgba(30,47,16,0.2)",r:"rgba(200,24,0,0.4)"},st="rgba(30,47,128,0.3)",it="rgba(240,240,255,0.6)",rt=268435456,lt=85445659.4471;Je.fn.NetworkMap=function(T){T=T||{},Ke={Map:google.maps.MapTypeId.ROADMAP,Sat:google.maps.MapTypeId.SATELLITE,Satellite:google.maps.MapTypeId.SATELLITE,Hyb:google.maps.MapTypeId.HYBRID,Hybrid:google.maps.MapTypeId.HYBRID,Ter:google.maps.MapTypeId.TERRAIN,Terrain:google.maps.MapTypeId.TERRAIN},$e=[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.TERRAIN],Qe=new google.maps.LatLng(0,0),Xe=new google.maps.LatLngBounds,_.defaults(T,{node_data_params:{f:"id mac tags status# alerting lat lng usage# is_gateway contact_name clients# nass gwhops# curnbrs gateway_route model product_short_description last_active# channels power_reduction"},size:"large",cluster_cutoff_count:500,show_count:!0,load_data:!0,move_nodes_enabled:!0,nodes:Mkijson.n.hash,override_center_prefs:!1,map_type_ids:$e,prefs_key:Mkiconf&&Mkiconf.user_dashboard_prefs&&(Mkiconf.network_eid||Mkiconf.wireless)?"n."+(Mkiconf.network_eid||Mkiconf.wireless.eid):void 0,wireless_only:!0,no_prefs:!1,disable_wireless_options:!1,disable_neighbors:!1,no_custom_maps:!1,on_data_loaded:[],map_type_changed:[],floorplans:MKI.Current.get("ng").get("floorplans"),save_prefs:!0,custom_controls:!0,hide_info_box:!1,legend_box:null,extra_controls:null,home_button:!0,custom_bounds:null,map_type_label:"network",center_on_nodes:!1,nodes_list:MKI.Current.get("ng").get("nodes"),disable_fetch:!1});var i,r,n,l,o,a,s,d,c,p,u,g,m,P,f,h,v,y,w,b,L,k,M,x,C,I,O,N,B,E={},A={},S=[],z=[],R={},j={},D=new google.maps.LatLngBounds,Z=new Hiatus({max_run_size:50,timeout_length:1}),t=!1,W=!1,H={},F=[],G={},U=1,e=Mkiconf.node_json_url,q=[],V=T.nodes,Y=[],J=new Backbone.Model({}),K=1,$=(Mkiconf.products,!1),Q={},X=!1;function ee(e){var t,o;!function(e,t){v=Je("<div class='network_map_div'>"),e.addClass("network_map "+T.size).append(v),P=new google.maps.Map(v.get(0),t),(E.map=P).setTilt(0),J.get("show_nodes")||J.set("show_nodes",!0);_.each(j,function(e,t){P.mapTypes.set(t,new google.maps.ImageMapType(e))}),l=j[E.current_map_type_id()],d=new de({map:P}),ae(),google.maps.event.addListenerOnce(P,"idle",function(){google.maps.event.addListenerOnce(P,"idle",function(){y=!0,te();var e=J.get("floorplans");!T.no_custom_maps&&e&&(Ze("show"==e&&!l),T.floorplans.on("reset add remove",function(){var e=!j[E.current_map_type_id()];Ze("show"==J.get("floorplans")&&e)}))}),se(!0),google.maps.event.addListener(P,"maptypeid_changed",se),oe()})}(e,function(e){var t=J.get("type"),o=T.map_type_ids,n={mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!!o,mapTypeControlOptions:{mapTypeIds:o,style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR},overviewMapControl:!0,panControl:"small"!==T.size&&!Mkiconf.on_mobile_device,panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},scaleControl:!0,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.DEFAULT,position:"small"!==T.size?google.maps.ControlPosition.LEFT_TOP:google.maps.ControlPosition.TOP_LEFT}};!T.no_custom_maps&&T.floorplans&&(window.setup_custom_maps(),j=CustomMaps.getFloorplanMapTypes(T.floorplans.toJSON()));if(J.get("current_node_id")){var a=J.get("current_node_id"),s=V[a],a=T.no_custom_maps?[]:_.pluck(T.floorplans.findByNode(a),"id"),s=new google.maps.LatLng(s.lat,s.lng).equals(Qe)?null:$e;n.mapTypeId=a[0]||s[0],n.mapTypeControl=!!s,n.mapTypeControlOptions.mapTypeIds=s,j=_.pick(j,a)}else if(_.contains(o,t)||T.no_custom_maps)_.contains(o,t)&&(n.mapTypeId=t);else{a=T.floorplans.get(t);if(!a)return n;p=!0,a.get("node_floorplan_placements").fetch({success:function(){p=!1,E.node_data_updated(),te()}}),e.append("<img style='display: none' src='"+a.get("imageUrl")+"'>");a=j[t]||_.findWhere(j,{name:t}),a=a?a.key:t,t=_.union(_(j).keys(),o);_.contains(t,a)||(o=Ke[a],a=o&&_.contains(t,o)?o:null),n.mapTypeId=a}return n}(e)),T.search_filter&&(C=T.search_filter,Je(C).on("change:results",function(e){I=T.search_filter_handler?T.search_filter_handler(C.results):_.indexBy(C.results,"id"),_e(),ke()})),function(){var e=Je("<div>");De(e);e[0].index=1,P.controls[google.maps.ControlPosition.TOP_LEFT].push(e[0]);e=Je("<div>");T.custom_controls&&function(e){var t=!1,a=Je("<div>",{class:"custom_map_control custom_map_options"});e.append(a),a.append(Je('<div class="dropdown_button"><i class="fa fa-cog"></i></div>'));var o=Je("<div>",{class:"dropdown_container"});a.append(o),T.show_count&&(t=!0,e=Je("<ul>"),o.append("<div><span class='heading'>Markers</span> <input type='checkbox' id='markerShowCheck' checked='checked'>Show</input></div>").append(e),s=Je("<select>",{name:"marker_type_opts"}),r=je("markers"),_({Plain:"x","AP type":"p",Clients:"c","Current clients":"nass","Hops to gateway":"h"}).chain().extend(r).each(function(e,t){var o={id:"marker_type_opt_"+e,value:e};J.get("markers")&&J.get("markers")==e&&(o.selected=!0),J.get("markers")||"c"!=e||(o.selected=!0);t=Je("<option>",o).html(t);s.append(t)}),e.append(Je("<li>").append(s)),a.find("#markerShowCheck").click(function(){Je(".overlay").toggle(Je("#markerShowCheck").is(":checked"))}));{var n;T.disable_wireless_options||T.disable_neighbors||(t=!0,n=Je("<ul>"),o.append("<div class='heading'>Neighbors</div>").append(n),s=Je("<select>",{name:"neighbor_line_opts"}),r=je("lines"),_({None:"x","Light lines":"l","Dark lines":"d","Red Lines":"r"}).chain().extend(r).each(function(e,t){var o={id:"line_opt_"+e,value:e};J.get("neighbors")&&J.get("neighbors")==e&&(o.selected=!0),J.get("neighbors")||"x"!=e||(o.selected=!0);t=Je("<option>",o).html(t);s.append(t),n.append(Je("<li>").append(s))}))}!T.disable_wireless_options&&T.disable_neighbors&&(t=!0);{var s;T.show_count&&"small"!=T.size&&(t=!0,o.append("<div class='heading'>Circles</div>"),i=Je("<ul>"),s=Je("<select>",{name:"circle_opts"}),r=je("circles"),_({None:"x",Usage:"usage"}).chain().extend(r).each(function(e,t){var o={id:"circle_opt_"+e,value:e};J.get("circle")&&J.get("circle")==e&&(o.selected=!0),J.get("neighbors")||"x"!=e||(o.selected=!0),s.append(Je("<option>",o).html(t))}),i.append(Je("<li>").append(s)),o.append(i))}{var i,r;T.no_custom_maps||"small"==T.size||(o.append("<div class='heading'>Floor plans</div>"),i=Je("<ul>"),s=Je("<select>",{name:"fp_opts"}),r=je("floorplans"),_({None:"x",Show:"show"}).chain().extend(r).each(function(e,t){var o={id:"line_opt_"+e,value:e};J.get("floorplans")&&J.get("floorplans")==e&&(o.selected=!0),J.get("floorplans")||"x"!=e||(o.selected=!0),s.append(Je("<option>",o).html(t))}),i.append(Je("<li>").append(s)),o.append(i))}return a.find(".dropdown_button").on("click",function(e){return a.toggleClass("open"),e.stopPropagation(),!1}),a.find("select").on("change",function(e){var t,o=Je(this),n=o.prop("name");"marker_type_opts"==n?(t=o.val(),J.set("markers","c"==t?null:t),ke()):"neighbor_line_opts"==n?(J.set("neighbors",o.val()),Le()):"circle_opts"==n?(J.set("circle",o.val()),ke()):"fp_opts"==n&&(o=o.val(),J.set("floorplans",o),Ze("show"==o&&!l)),_.defer(function(){a.addClass("open")})}),Je("body").on("click",function(){a.removeClass("open")}),a.on("click",function(e){e.stopPropagation()}),t}(e)&&(e[0].index=-2,P.controls[google.maps.ControlPosition.TOP_RIGHT].push(e[0]));T.no_custom_maps||T.no_floorplans_dropdown||(T.floorplans.setVisibleNodes(J.get("current_node_id")),(e=new MKI.Views.CustomMapDropdown({collection:T.floorplans,map:P,initial_map_name:E.map_name()})).$el[0].index=-1,P.controls[google.maps.ControlPosition.TOP_RIGHT].push(e.$el[0]))}(),(g=info_box.init({marker_height:124.3/3})).quadrant=1,g.pos_offset={x:-2},google.maps.event.addListener(P,"zoom_changed",function(){Je(g.div_).hide(),P.getZoom()}),v.on("mouseenter",".info_box",function(){P.setOptions({scrollwheel:!1}),clearTimeout(Je(g.div_).data("timeout_id"))}).on("mouseleave",".info_box",function(){P.setOptions({scrollwheel:!0})}),ge(Be),me(Te),me(function(){P.setOptions({draggable:!1})}),fe(Oe),fe(function(e){P.setOptions({draggable:!0})}),Je(document).mousemove(function(e){L=e.pageX,k=e.pageY,Ne()}),v.on("click",".info_box.cluster .offset_info",Ie),(e=T.legend_box)&&(o=Je("<div>",{id:"map_legend"}),(t=Je("<div>",{class:"custom_map_legend_inner"})).appendTo(o),e.appendTo(t),o[0].index=0,o[0].className+="custom_map_legend",P.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(o[0])),(e=T.extra_controls)&&(t=Je("<div>",{id:"map_extra_controls"}),(o=Je("<div>",{class:"custom_map_extra_controls_wrapper"})).appendTo(t),e.appendTo(o),t[0].index=-3,P.controls[google.maps.ControlPosition.TOP_RIGHT].push(t[0])),page_inited=!0}function te(){p||c||!y||_.each(E.on_data_loaded,function(e){e()})}function oe(){F=F.concat([google.maps.event.addListener(P,"dragend",Se),google.maps.event.addListener(P,"zoom_changed",Se),google.maps.event.addListener(P,"tilt_changed",ne),google.maps.event.addListener(P,"heading_changed",ne)])}function ne(){X=W=!0}function ae(){var t,e=j[E.current_map_type_id()],o=T.floorplans.get(E.current_map_type_id());e||o?(h=Qe,w=18):(o=T.nodes_list.get(J.get("current_node_id")))?(h=new google.maps.LatLng(o.get("lat"),o.get("lng")),w=20):T.center_on_nodes?(t=new google.maps.LatLngBounds,T.nodes_list.each(function(e){t.extend(new google.maps.LatLng(e.get("lat"),e.get("lng")))}),f=t,P.fitBounds(f),h=t.getCenter(),w=P.getZoom()):isNaN(+J.get("lat"))||isNaN(+J.get("lng"))?(P.setCenter(Qe),P.setZoom(2)):(h=new google.maps.LatLng(J.get("lat"),J.get("lng")),w=0<=+J.get("zoom")?+J.get("zoom"):20),h&&w&&(P.setCenter(h),P.setZoom(w))}function se(e,t){e||J.set("type",E.current_map_type_id());e=b;b=P.getMapTypeId(),2!=_.intersection(["roadmap","satellite","hybrid","terrain"],[e,b]).length&&(_.each(F,function(e){google.maps.event.removeListener(e)}),X=!(F=[]),d&&d.markerLayer.empty(),_e(),(0<S.length||0<z.length)&&we(),_.each(G,function(e){e.setMap(null)}),l&&u&&u.setMap(null),l=j[t]||j[E.current_map_type_id()],t=T.floorplans.get(E.current_map_type_id()),!l&&t&&(E.update_custom_map_types(t),l=j[t.id]),l?(Je("#floor_overlay, #overlay_toolbar").fadeOut(),Je(".current_overlay").removeClass("current_overlay"),(s=CustomMaps.getCustomMapOverlay(P)).getProjection()?(ie(l),re()):google.maps.event.addListenerOnce(P,"idle",function(){ie(l),re()})):(K=1,Je("#custom_map_header_text").text("Floor plans"),re(),Ze("show"==J.get("floorplans"))),P.setOptions({mapTypeControl:!0}),N&&N.hide())}function ie(e){var t,o=T.floorplans.get(e.key);E.pixels_per_meter=null,o.get("is_geoaligned")?function(e,t){K=1,e.geometry={bounds:t.getBounds()};var o=T.nodes_list.get(J.get("current_node_id"));w=o?(o=new google.maps.LatLng(o.get("lat"),o.get("lng")),h=t.rotatedLatLng(o,!0),20):(h=t.get("center"),P.fitBounds(e.geometry.bounds),P.getZoom());(u=new google.maps.GroundOverlay(t.get("imageUrl"),e.geometry.bounds)).setMap(P)}(e,o):(void 0===e.geometry&&(e.geometry=(t=o,{min_res:18-Math.floor(Math.max(Math.log(t.get("pixel_width")/25)/Math.LN2,Math.log(t.get("pixel_length")/25)/Math.LN2)),max_res:22,bounds:t.getBounds(s,Qe)}),E.pixels_per_meter=o.get("pixels_per_meter")||void 0),K=4,t=T.nodes_list.get(J.get("current_node_id")),w=t?(t=o.get("node_floorplan_placements").findWhere({node_id:t.id}),h=new google.maps.LatLng(t.get("deg_north"),t.get("deg_east")),20):(h=Qe,18),(u=new google.maps.GroundOverlay(o.get("imageUrl"),e.geometry.bounds)).setMap(P)),Ze(!1)}function re(){!function(){var t=E.is_custom();_.each(Y,function(e){e.toggle(!t)}),a&&a.parent().toggleClass("custom",t);o&&!t&&o.find("span").text("");a&&!t?a.find("li").removeClass("selected"):t||Je(".custom_map_type li").removeClass("selected")}(),ve(),ye(t,h,w),$=!1,window.map_client_location&&d&&window.map_client_location.update();var e=window.map_placement2;e&&(e.update_placelist_pagination(),e.update_placement_count(),e.reset_tracked_movements()),oe(),ke(),_.each(T.map_type_changed,function(e){e()}),te(),google.maps.event.trigger(P,"idle")}function le(){var e,t,o,n=P.getBounds();n&&(D=new google.maps.LatLngBounds(n.getSouthWest(),n.getNorthEast()))&&(e=D.getNorthEast(),t=D.getSouthWest(),o=1.1*(e.lat()-t.lat())/2,n=1.1*(e.lng()-t.lng())/2,D.extend(new google.maps.LatLng(e.lat()+o,e.lng()+n)),D.extend(new google.maps.LatLng(t.lat()-o,t.lng()-n)))}function de(e){this.markerLayer=Je("<div>",{class:"overlay"}),this.shapesLayer=Je("<canvas>",{class:"overlay"}),this.shapesCanvas=this.shapesLayer.get(0);var t=this;google.maps.event.addListener(this,"map_changed",function(){this.mapBoundsListener&&(google.maps.event.removeListener(this.mapBoundsListener),this.mapBoundsListener=null);var e=this.getMap();e&&(this.mapBoundsListener=google.maps.event.addListener(e,"bounds_changed",function(){var e;(e=P.getBounds())&&!_.any([e.getNorthEast(),e.getSouthWest()],function(e){return!D.contains(e)})||(le(),_.defer(_.bind(t.draw,t))),x&&(qe(),x=!1)}))}),this.setValues(e)}function _e(){var e;d&&((e=d.shapesCanvas.getContext("2d")).save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,d.shapesLayer.width(),d.shapesLayer.height()),e.restore())}function ce(e){e&&(function(e){_.each(e.node_ids,function(e){e=V[e];e.point=null,e.cluster_id=null,e.visible=!1}),e.point&&(e.point.remove(),e.point=null);e.circle&&(e.circle.setMap(null),e.circle=null)}(e),delete R[e.id])}function pe(e){var t=E.current_map_type_id(),o=T.floorplans.get(t),n=!!o,a=n&&o.get("is_geoaligned"),s=Je(this).data("node-id"),t=v.offset(),t={x:Je(this).offset().left-t.left+Je(this).width()/2,y:Je(this).offset().top-t.top+Je(this).height()},i=E.get_projection().fromContainerPixelToLatLng(t);if(a&&(i=o.rotatedLatLng(i),!o.containsLatLng(i)))return Je.top_status({box_class:"bad",content:"Move failed. The position was outside of this floorplan.",remove_after:5e3}),void E.node_data_updated();var a=n&&!a?[]:_.filter(T.floorplans.haveNode(s),function(e){return e.get("is_geoaligned")}),r=[];_.each(a,function(e){e.containsLatLng(i)||(e.removeNode(s),e.save(),r.push(e))}),Fe(V[s],i,!1,0,!1,{affected:a,removed_from:r},"network_map node_dragged")}function ue(e){var t=J.get("markers");if("x"==t)return 0;e=V[e];if("p"!=t)return"h"==t?e["gwhops#"]:A[t]?A[t].text.call(this,e):e[t||"clients#"]||0;e=e.product_short_description||e.model;return e?e.replace(/mr|-.*/gi,""):""}function ge(e){v.on("click",".map-point",e)}function me(e){v.on("mouseenter",".map-point",e)}function fe(e){v.on("mouseleave",".map-point",e)}function he(e){var t,t=(t=e)&&t.hasClass("map-point")&&(t=t.data("nodeId"))?V[t]:null,e=(e=e)&&e.hasClass("map-point")&&e.hasClass("cluster")?(e=e.data("cluster_id"),R[e]):null;return{node:t,cluster:e,either:t||e}}function ve(){i=new google.maps.LatLngBounds;var o,n,a,s,e,t=T.floorplans.get(P.getMapTypeId());_.each(V,function(e){e.is_placed=!1,e.loc=null}),t?t.get("is_geoaligned")?(n=t,!h||(a=T.nodes_list)&&!a.isEmpty()&&(s=J.get("current_node_id"),e=_.chain((n.get("node_ids")||"").split(",")).compact().intersection(a.pluck("id")).value(),_.each(e,function(e){var t=a.get(e),t=new google.maps.LatLng(t.get("lat"),t.get("lng"));s&&s!=e||i.extend(t);t=n.rotatedLatLng(t,!0),e=V[e];e&&(e.loc=t,e.is_placed=!0)}))):(t=(t=t).get("node_floorplan_placements"))&&!t.isEmpty()&&(o=J.get("current_node_id"),t.each(function(e){var t=e.get("node_id"),e=new google.maps.LatLng(e.get("deg_north"),e.get("deg_east"));o&&o!=t||i.extend(e);t=V[t];t&&(t.loc=e,t.is_placed=!0)})):T.nodes_list.each(function(e){var t,o=V[e.id];o&&(e=!!Ve(o,t=Ce(e)),o.loc=t,o.is_placed=e,T.wireless_only&&o.product_type&&(o.is_placed=e&&"wireless"==o.product_type),e&&i.extend(t))})}function ye(e,t,o){if(e||!$){if(!e&&t&&!T.center_on_nodes)return P.setCenter(t),void(0<=+o&&P.setZoom(+o));T.center_on_nodes&&f&&(P.fitBounds(f),w=P.getZoom());o=ze();e||"small"==T.size||void 0===J.get("lat"+o)||void 0===J.get("lng"+o)||void 0===J.get("zoom"+o)?0==q.length&&0===_.keys(V).length||i.equals(Xe)?(E.is_custom()?P.setZoom(18):P.setZoom(2),P.setCenter(Qe)):(P.fitBounds(i),20<P.getZoom()&&P.setZoom(20)):(E.is_custom()||X||(P.setHeading(0),P.setTilt(0)),P.panTo(new google.maps.LatLng(J.get("lat"+o),J.get("lng"+o))),o=J.get("zoom"+o),P.getZoom()!=o&&P.setZoom(o))}}function we(){_.each(S,function(e){e.setMap(null)}),S=[],_.each(z,function(e){e.setMap(null)}),z=[]}function be(e){e=e||{};var t=new google.maps.LatLng(e.lat,e.lng),o=new google.maps.Marker({position:t,icon:e.icon||(n=n||new google.maps.MarkerImage("/images/blue_ball.png",null,null,new google.maps.Point(6,6),new google.maps.Size(12,12))),map:P});return o.setZIndex(101),S.push(o),e.prob_radius&&(e=new google.maps.Circle({center:t,strokeWeight:0,fillColor:et,map:P,radius:e.prob_radius}),z.push(e)),t}function Le(){_.each(G,function(e){e.setMap(null)}),0!=G.length&&at[J.get("neighbors")]&&_.each(R,Me)}function ke(){W=!0,d&&(_.bind(d.draw,d)(),window.map_client_location&&window.map_client_location.update())}function Me(o){var e=_.chain(o.node_ids).map(function(e){return V[e]}).reject(node_is_dedicated_air_marshal).value(),n=at[J.get("neighbors")];(T.disable_wireless_options||T.disable_neighbors)&&(n=null);e=_.chain(e).reduce(function(e,t){return e.concat(t.curnbrs?_.keys(t.curnbrs):[])},[]).map(function(e){return V[e]}).compact().reject(node_is_dedicated_air_marshal).map(function(e){return R[e.cluster_id]}).compact().value();_.each(e,function(e){var t=[o.id,e.id].sort(),e=t.join("-"),t=_.chain(t).map(function(e){return R[e].bounds.getCenter()}).compact().value(),e=G[e]=G[e]||new google.maps.Polyline({strokeWeight:4});n&&!e.getMap()&&(e.setPath(t),e.setMap(P),e.setOptions({strokeColor:n})),n||e.setMap(null)})}function xe(e,t){e&&!e.is_gateway&&e.gateway_route?_.contains(["hover","selected"],t)?(e.gateway_map_line=e.gateway_map_line||new google.maps.Polyline({strokeWeight:3}),e.gateway_map_line.setOptions({strokeColor:tt["selected"==t?"s":"n"]}),(t=_(e.gateway_route.split(" ")).collect(function(e){e=V[e];return e&&null!=e.cluster_id&&R[e.cluster_id]?R[e.cluster_id].bounds.getCenter():null})).unshift(e.loc),e.gateway_map_line.setPath(_.compact(t)),e.gateway_map_line.setMap(P)):e.gateway_map_line&&e.gateway_map_line.setMap(null):_.each(V,function(e){e.gateway_map_line&&e.gateway_map_line.setMap(null)})}function Ce(e){var t=e.id+"",o=e.get("lat"),n=e.get("lng");if(l){var a=T.floorplans.get(l.key);if(a.get("is_geoaligned")){e=_.compact((a.get("node_ids")||"").split(","));if(_.contains(e,t))return new google.maps.LatLng(o,n)}else{t=a.get("node_floorplan_placements").findWhere({node_id:t});if(t)return new google.maps.LatLng(t.get("deg_north"),t.get("deg_east"))}return null}return null==o||null==n?null:new google.maps.LatLng(o,n)}function Te(){var e,t;T.hide_info_box||(t=he(Je(this)),clearTimeout(Je(g.div_).data("timeout_id")),m&&t.either&&m.id===t.either.id||(m&&m.point&&m.id!==t.either.id&&m.point.removeClass("hover"),(e=t.node)&&(g.pos_offset.y=0,g.position_=e.loc,g.setContent(function(e){var t=e.name||(e.contact_name?e.contact_name+"'s Phone":e.mac);t=Mkiconf.monitor_only?name_for_node(e.id,t):T.get_node_link?T.get_node_link(e):link_for_node(e.id,t);return"<div class='monitor-only-no-link info_box'><table><tr><td>"+node3_render_status(e,!0)+"</td><td>"+t+"</td></tr></div>"}(e)),xe(e,"hover"),m=e,g.setMap(P)),(e=t.cluster)&&(t=e.point.prop("class"),/tiny|1_digits/i.test(t)?g.pos_offset.y=9.4:/2_digits/i.test(t)?g.pos_offset.y=11.75:g.pos_offset.y=94/3/2,g.position_=e.bounds.getCenter(),g.setContent(function(o){var n="<div class='info_box cluster'><div class='inner'><div class='device_count'>"+o.node_ids.length+" "+(Mkiconf.devices_noun_plural||"access points")+"</div>";return _.each(o.status_counts,function(e,t){isNaN(t)||0!=e&&(n+="<table>",e=Pe(o,0,10,t),n+=e.content,e.offset<o.node_ids.length&&(n+="<tr><td colspan='2' class='offset_info' data-cluster_id='"+o.id+"' data-status='"+t+"' data-offset='"+e.offset+"'>Show more...</td></tr>"),n+="</table>")}),n+="</div></div>"}(e)),m=e,g.setMap(P))))}function Pe(e,t,o,n){var a="",s="health_"+n,o=function(e,t,o,n){Math.min(e.node_ids.length,t+o);var a,s=[],i=e.node_ids.length;for(a=t;a<i&&s.length<o;a++){var r=V[e.node_ids[a]];n&&!n(r)||s.push(r)}return{nodes:s,offset:a}}(e,t,o,function(e){return e.health==n});return _.each(o.nodes,function(e){var t=e.name||e.mac,t=T.get_node_link?T.get_node_link(e):"<a class='"+s+"' href='"+url_for_node(e.id)+"' title='"+t+"'>"+t+"</a>";a+="<tr><td style='vertical-align:top;'>"+node3_render_status(e,!0)+"</td><td>"+t+"</td></tr>"}),{content:a,offset:o.offset}}function Ie(){var e=Je(this).data(),t=R[e.cluster_id],e=Pe(t,e.offset,20,e.status);Je(this).closest("tr").before(Je(e.content)),0<e.content.length&&e.offset<t.node_ids.length?Je(this).data("offset",e.offset):Je(this).remove()}function Oe(){var e,t=he(Je(this));Ee()&&t.either&&Ee().id==t.either.id||((e=t.node)&&xe(e,null),t.cluster&&xe(null),H.timeout_id=setTimeout(function(){!function(e){e?Je(g.div_).fadeOut("300"):Je(g.div_).hide();m=m&&null;g.content_=""}(!0)},500),g&&Je(g.div_).data("timeout_id",H.timeout_id))}(de.prototype=new google.maps.OverlayView).onAdd=function(){var t=Je(this.getPanes().overlayImage);t.append(this.shapesLayer),t.append(this.markerLayer),T.image_overlays&&_.each(T.image_overlays,function(e){t.append(e.layer)})},de.prototype.onRemove=function(){this.markerLayer.remove(),this.shapesLayer.remove(),T.image_overlays&&_.each(T.image_overlays,function(e){e.layer.remove()})},de.prototype.draw=function(){var o,n,a=this,s=this.getProjection(),i=this.getMap().getZoom();function e(){var d,c=R,p=P.getZoom(),e=o.length,u=_.keys(c),g=e>T.cluster_cutoff_count;Z.run_with_array(o,function(e){_.each(e,function(e){for(d=u.length-1;0<=d;d--){if(J.get("current_node_id")&&e.id==J.get("current_node_id")){d=-1;break}var t=u[d],o=c[t];if(!o.is_current_node&&(g&&(n=e.loc,a=o.node_loc,s=p,r=i=void 0,i=m(n.lng()),r=f(n.lat()),n=m(a.lng()),a=f(a.lat()),Math.sqrt(Math.pow(i-n,2)+Math.pow(r-a,2))>>21-s<=22))){o.node_ids.push(e.id),o.bounds.extend(e.loc),o.status_counts[e["status#"]]++,e.cluster_id=t,o.up_to_date=!1;break}}var n,a,s,i,r,l,o;-1===d&&((l=new google.maps.LatLngBounds).extend(e.loc),e.cluster_id=U,(o=c[U++]={id:e.cluster_id,node_loc:e.loc,node_ids:[e.id],bounds:l,status_counts:{0:0,1:0,2:0,3:0}}).status_counts[e["status#"]]++,J.get("current_node_id")&&e.id==J.get("current_node_id")&&(o.is_current_node=!0),u.push(e.cluster_id))})},function(){var o;R=c,o=document.createDocumentFragment(),Z.run_with_object(R,function(e){_.each(e,function(e){var t,e=R[e];e.up_to_date||(e.point&&e.point.remove(),t=function(e,t){var o=1==t.node_ids.length,n=o&&!V[t.node_ids[0]].is_gateway,a="p"==J.get("markers"),s=e.fromLatLngToDivPixel(t.bounds.getCenter()),i="",e=!o&&(null==J.get("markers")||"nass"==J.get("markers"));T.show_count&&(!o&&e?i=_.chain(t.node_ids).map(ue).reduce(function(e,t){return e+t}).value():o&&(i=ue(t.node_ids[0])));J.get("current_node_id")&&(r=_.any(t.node_ids,function(e){return e==J.get("current_node_id")}));var e="map-point "+(r?"current ":"")+(i?"with_"+i.toString().length+"_digits ":"tiny ")+(o?"":"cluster ")+(J.get("current_node_id")?"transparent":""),r=window["node_"+(o?n?"repeater":"pin":"cluster")+"_image_url"],n="";J.get("show_nodes")&&(n='<img src="'+r(function(e){e=_.chain(e.node_ids).map(function(e){var t=V[e];return V[e].health=t.health||calc_node_health(t)}).countBy(function(e){return e}).value(),e=_.omit(e,"3");return 0<_.keys(e).length?_.max(_.keys(e)):3}(t),"hover")+'" />'+(i?"<span"+(a?' class="ap_type">':">")+i+"</span>":""));n=Je('<div class="'+e+'" data-cluster_id="'+t.id+'" '+(o?'data-node-id="'+t.node_ids[0]+'" ':"")+'style="left:'+s.x+"px; top:"+s.y+'px; -webkit-transform:translateZ(0px);">'+n+"</div>");o&&T.move_nodes_enabled&&(Mkiconf.monitor_only||!Mkiconf.can_write?n.draggable("disable "):n.draggable({stop:pe}));return n}(s,e),_.each(e.node_ids,function(e){_.extend(V[e],{point:t,visible:!0})}),e.point=t,o.appendChild(t.get(0)),e.up_to_date=!0)})},function(){Le(),a.markerLayer.append(o);var e=Ee();e&&e.point&&e.point.addClass("selected"),J.get("circle")&&"x"!=J.get("circle")&&T.show_count&&"small"!=T.size&&function(){var o;"usage"==J.get("circle")?o=t:A[J.get("circle")]&&A[J.get("circle")].radius&&(o=A[J.get("circle")].radius);o&&_.each(R,function(e){var t;e.radius=o(e)*K,e={radius:(t=e).radius,fillColor:st,fillOpacity:.6,strokeColor:it,strokeOpacity:.8,strokeWeight:1},t.circle||(t.circle=new google.maps.Circle(_.extend({map:P,center:t.bounds.getCenter()},e)))})}(),T.image_overlays&&_.each(T.image_overlays,function(e){_.bind(e.draw,e.layer,E)()})})})}function t(e){var t=850*Math.pow(2,i-17);return e.usage=e.usage||_.reduce(e.node_ids,function(e,t){return e+V[t]["usage#"]},0),Math.sqrt(e.usage)/t}function m(e){return Math.round(rt+lt*e*Math.PI/180)}function f(e){return Math.round(rt-lt*Math.log((1+Math.sin(e*Math.PI/180))/(1-Math.sin(e*Math.PI/180)))/2)}le(),D&&(!W&&i==B||(W=!1,this.markerLayer.empty(),_e(),_.each(R,ce)),B=i,o=[],n=V,Z.run_with_object(n,function(e){_.each(e,function(e){var t=n[e];if(t.is_placed){e=!I||0===I.length||I[t.id];if(!e||!t.loc||!D.contains(t.loc))return t.visible&&ce(R[t.cluster_id]),void(t.visible=!1);(!t.visible&&e||t.visible&&!a.markerLayer.children().length)&&o.push(t)}})},e))};var Ne=_.debounce(function(){var e,t,o;m&&(o=Je(g.div_),e={x:L,y:k},(t=o.offset())&&(o={w:o.outerWidth(),h:o.outerHeight()},t.left-=o.w/2,(e.x>t.left+o.w+20||e.x<t.left-20||e.y>t.top+o.h+20||e.y<t.top-m.point.outerHeight())&&(_.bind(Oe,m.point)(),P.setOptions({draggable:!0,scrollwheel:!0}))))},100);function Be(){var e,t;Mkiconf.monitor_only||((e=he(Je(this))).node?e.node.point.hasClass("selected")&&g.div_&&(window.location=Je(g.div_).find("a").prop("href")):(t=e.cluster).point.hasClass("selected")&&function(e){P.fitBounds(e.bounds)}(t),function(e){O&&(O.node,O.cluster,O.either&&O.either.point&&O.either.point.removeClass("selected"));(O=e).either&&(O.node,O.cluster,O.either.point.addClass("selected"))}(e))}function Ee(){return O?O.either:null}function Ae(){Je.ajax({url:e,data:T.node_data_params,jsonp:"jsonp",dataType:"jsonp"}).done(function(e){Mkiconf.products=e.products,_.each(e.nodes,function(e,t){V[t]=_.extend({},V[t],e)}),window.map_placement2&&window.map_placement2.update_table_items(V),E.node_data_updated()})}function Se(){google.maps.event.addListenerOnce(P,"idle",function(){var e,t,o;0==F.length||T.override_center_prefs||T.floorplans.get(P.getMapTypeId())||(e=ze(),t=P.getCenter(),"small"!=T.size&&t&&((o={})["lat"+e]=t.lat(),o["lng"+e]=t.lng(),o["zoom"+e]=P.getZoom(),J.set(o)))})}function ze(){var e=E.map_name();return e&&"."+e}function Re(){r&&(P.fitBounds(r.circle.getBounds()),r.circle.setMap(P),qe(!0,"Map centered on your location",1500),_.delay(function(){r.circle.setMap(null)},2500))}function je(t){var o={};return _.each(Q,function(e){e[t]&&_.each(e[t],function(e,t){o[e.menu]=t})}),o}function De(e){var t=Je("<div>",{class:"custom_map_position_control_wrapper"}).appendTo(e),o=Je("<div>",{class:"custom_map_control custom_map_position"}).appendTo(t),n=Je("<span data-toggle='tooltip' title='Go to "+T.map_type_label+" center'><i class='fa fa-home'></i></span>"),e=Je("<span data-toggle='tooltip' title='Go to your current location'><i class='fa fa-crosshairs'></i></span>"),t=Je("<span data-toggle='tooltip' title='Go to a specific location'><i class='fa fa-search'></i></span>"),a=Je("<span style='display: none'></span>"),s=Je("<input type='text' size='40' placeholder='Address, city, zipcode, lat/lng...'></input>").appendTo(a);T.home_button&&o.append(n),navigator.geolocation&&o.append(e),o.append(t).append(a).find("span").tooltip({container:"body"}),Y.push(t),Y.push(e),google.maps.event.addDomListener(n[0],"click",E.force_recenter),google.maps.event.addDomListener(e[0],"click",function(){var t;t=!0,E.is_custom()||void 0!==navigator.geolocation&&(x=!0,t&&qe(!0,"Retrieving your location..."),navigator.geolocation.getCurrentPosition(function(e){var t;x&&(x=!1,t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),P.setCenter(t),e=new google.maps.Circle({radius:e.coords.accuracy,center:t,strokeColor:ot,strokeWeight:2,fillColor:nt,map:P}),r&&r.circle.setMap(null),r={center:t,circle:e},Re())},function(e){if(x=!1,e.code!=e.PERMISSION_DENIED){if(e.code==e.TIMEOUT){if(r)return void Re();t&&qe(!1,"Timed out retrieving your location",5e3)}t&&qe(!1,"Could not retrieve your location",5e3)}else t&&qe(!1,"Permission denied.  Re-enable location for this site in your browser's settings",5e3)},{maximumAge:6e4,timeout:8e3,enableHighAccuracy:!0}))}),t.on("click",function(e){return a.toggle(),s.focus().select(),e.stopPropagation(),!1}),s.on("keyup",function(e){var t=Je(this).val();13==e.keyCode?(verifyAddressV3Extended({address:t,bounds:P.getBounds(),on_error:function(e){qe(!1,"No matches ("+e+")",5e3)},on_success:function(e){qe(!0,'Map centered at "'+_.escape(e.formatted_address)+'"',1500),P.fitBounds(e.geometry.viewport)}}),a.hide()):27==e.keyCode&&(a.hide(),s.val(""))}).on("click",function(e){return e.stopPropagation(),!1}),Je("body").on("click",function(){a.hide()})}function Ze(e){var t,o;T.no_custom_maps||T.disable_wireless_options||"small"==T.size||(t=T.floorplans.geoaligned(),window._all_floorplan_overlays?_.size(_all_floorplan_overlays)!=t.length&&(_(t).each(function(e){_all_floorplan_overlays[e.id]||(_all_floorplan_overlays[e.id]=new Ye(e,P))}),o=_.filter(_all_floorplan_overlays,function(e){return!T.floorplans.get(e._fp.id)}),_(o).each(function(e){e=e._fp.id;_all_floorplan_overlays[e].setMap(null),_all_floorplan_overlays=_.omit(_all_floorplan_overlays,e)})):(window._all_floorplan_overlays={},_(t).each(function(e){_all_floorplan_overlays[e.id]=new Ye(e,P)})),e?Je(".fp_overlay").show():Je(".fp_overlay").hide())}function We(e,t,o,n){q.push([{node:e,loc:t,map:o,floorplans:n}])}function He(e){var n,e=e||q;_.isEmpty(e)||(n=e.pop(),_.each(n,function(e){var t,o;e.map==E.current_map_type_id()&&(t=e.node.id+"",o=e.floorplans,_.each(o.removed_from,function(e){e.addNode(t),e.save()}),_.each(o.added_to,function(e){e.removeNode(t),e.save()}),Fe(e.node,e.loc,!0,_.any(n),!1,void 0,"map_placement2 undo_node_movement"))}))}function Fe(e,t,o,n,a,s,i){var r,l,d,_,c,p,u,g,m,f,h,v,y,w,b,L,k,M;function x(){var e,t;b=b||Qe,u||(e=new google.maps.LatLng(b.lat,b.lng),t=g?g.removed_from:null,We(c,e,k,{removed_from:t,added_to:L?[M]:[]})),_show_undo_controls&&(Ge(),Ue(f?g:{})),E.node_data_updated(),google.maps.event.trigger(P,"node_moved")}function C(){window.map_placement2&&window.map_placement2.update_placelist_pagination(),E.node_data_updated(),Je.top_status({content:"Failed to save move.",box_class:"bad",remove_after:5e3,container:".network_map"})}N&&N.hide(),t=t||Qe,_show_undo_controls=!a,E.is_custom()?(c=e,p=t,u=o,g=s,m=i,k=E.current_map_type_id(),(M=T.floorplans.get(k))&&(f=M.get("is_geoaligned"),h=c.id+"",v=p.lat(),y=p.lng(),w=!v&&!y,f?(a=T.nodes_list.get(h),p=(M.get("node_ids")||"").split(","),b={lat:a.get("lat"),lng:a.get("lng")},w?(M.removeNode(h),M.save({},{success:x,error:C})):(-1!=p.indexOf(h)||u||(L=!0,M.addNode(h,T.nodes_list),M.save()),a.save({lat:v,lng:y,from_this_function:m},{success:x,error:C}))):((m=M.get("node_floorplan_placements").findWhere({node_id:h}))&&(b={lat:m.get("deg_north"),lng:m.get("deg_east")}),w?m.destroy({success:x,error:C}):m?m.save({deg_north:v,deg_east:y},{wait:!0,success:x,error:C}):M.get("node_floorplan_placements").create({floorplan_id:M.id,node_id:h,deg_north:v,deg_east:y},{success:x,error:C})),window.map_placement2&&window.map_placement2.update_placelist_pagination())):(t=t,l=o,d=s,s=i,_={lat:(r=e).lat,lng:r.lng},i=t.lat(),t=t.lng(),r.lat=i,r.lng=t,T.nodes_list.get(r.id+"").save({lat:i,lng:t,from_this_function:s},{success:function(e){var t,o;l||(t=new google.maps.LatLng(_.lat,_.lng),o=d?d.removed_from:null,We(r,t,E.current_map_type_id(),{removed_from:o})),_show_undo_controls&&(Ge(),Ue(d)),E.node_data_updated(),window.map_placement2&&window.map_placement2.update_placelist_pagination(),google.maps.event.trigger(P,"node_moved")},error:function(e){r.lat=_.lat,r.lng=_.lng,E.node_data_updated(),window.map_placement2&&window.map_placement2.update_placelist_pagination(),qe(!1,"Failed to save move.",5e3)}})),E.show_tooltip(e.id)}function Ge(){N||((N=Je(['<div class="undo_controls">',"<div><span>Device location updated.</span>",'<a class="btn btn-default btn-xs undo" href="#">Undo</a>','<div class="affected_floorplans affected"></div>','<div class="affected_floorplans removed"></div>',"</div>",'<a class="close_alert" href="#"><img src="/images/status_grey.png"/></a>',"</div>"].join(""))).find("a").on("click",function(e){return Je(this).hasClass("close_alert")?N.hide():Je(this).hasClass("undo")&&(e.preventDefault(),He(q)),!1}),v.before(N)),N.toggleClass("all_undone",0==q.length).fadeIn(200)}function Ue(e){var t=N.find(".affected_floorplans"),o=N.find("a.btn");if(_.isEmpty(e)||!e.affected)return t.addClass("no_info"),void o.css("float","none");var n=e.affected.length,e=e.removed_from.length;n?(t.first().removeClass("no_info").text("• "+n+" floorplan"+(1<n?"s":"")+" affected."),e?t.last().removeClass("no_info").text("• Device removed from "+e+" floorplan"+(1<e?"s":"")+"."):t.last().addClass("no_info"),o.css("float","right")):(t.addClass("no_info"),o.css("float","none"))}function qe(e,t,o){Je.remove_top_status(),(e||t)&&(e={content:t,box_class:e?"":"bad",container:T.status_container||".network_map"},o&&(e.remove_after=o),Je.top_status(e))}function Ve(e,t){var o=T.nodes_list;return!(!e||o.isEmpty())&&(e=o.get(e.id+""),(t=t||Ce(e))&&0!==t.lat()&&0!==t.lng()&&37.4180951010362!==t.lat()&&-122.098531723022!==t.lng())}function Ye(e,t){this._fp=e,this._image=e.get("imageUrl"),this._map=t,this._div=null,this.setMap(t)}return(Ye.prototype=new google.maps.OverlayView).onAdd=function(){var e=document.createElement("div");e.style.borderStyle="none",e.style.borderWidth="0px",e.style.position="absolute",Je(e).addClass("fp_overlay");var t=document.createElement("img");t.src=this._image,t.style.width="100%",t.style.height="100%",t.style.position="absolute",e.appendChild(t),this._div=e,J.get("floorplans")&&"x"!=J.get("floorplans")&&!l||Je(this._div).hide(),this.getPanes().overlayLayer.appendChild(e)},Ye.prototype.draw=function(){var e=this.getProjection(),t=this._fp.getBounds(),o=e.fromLatLngToDivPixel(t.getSouthWest()),e=e.fromLatLngToDivPixel(t.getNorthEast()),t=this._div;t.style.left=o.x+"px",t.style.top=e.y+"px",t.style.width=e.x-o.x+"px",t.style.height=o.y-e.y+"px",t.style.opacity="0.6";o=this._fp.get("rotation_angle");o&&(e=-1!=navigator.userAgent.indexOf("Firefox")?"transform":-1!=navigator.userAgent.indexOf("Chrome")||-1!=navigator.userAgent.indexOf("Safari")?"-webkit-transform":"-ms-transform",Je(t).css(e,"rotate("+o+"deg)"))},Ye.prototype.onRemove=function(){this._div.parentNode.removeChild(this._div),this._div=null},E.node_is_placed=function(e){return Ve(V[e])},E.map_name=function(){return E.is_custom()?l.name:""},E.current_map_type_id=function(){return P.getMapTypeId()},E.is_custom=function(){return!!l},E.is_legacy_floorplan=function(){return E.is_custom()&&"g_"!=P.getMapTypeId().substr(0,2)},E.get_ground_overlay_bounds=function(e){var t=j[e];return se(!1,e),t.geometry.bounds},E.node_data_updated=function(){window.page_inited&&(Oe(),ve(),ke())},E.get_projection=function(){return d.getProjection()},E.show_tooltip=function(e){((e=e&&V[e])&&e.point?_.bind(Te,e.point):Oe)()},E.pixel_dist=function(e,t){var o=Math.pow(2,P.getZoom()),e=P.getProjection().fromLatLngToPoint(e),e=new google.maps.Point(e.x*o,e.y*o),t=P.getProjection().fromLatLngToPoint(t),o=new google.maps.Point(t.x*o,t.y*o);return Math.sqrt((e.x-o.x)*(e.x-o.x)+(e.y-o.y)*(e.y-o.y))},E.pixel_radius=function(e,t,o){t=void 0===t?new google.maps.LatLng(0,0):t,o=void 0===o?0:o;o=google.maps.geometry.spherical.computeOffset(t,e,o);return this.pixel_dist(t,o)},E.get_overlay=function(){return CustomMaps.getCustomMapOverlay(this.map)},E.update_custom_map_types=function(e,t){t?j=_.omit(j,e.id):((t={})[e.id]=CustomMaps.getSingleMapType(e.toJSON()),_.extend(j,t))},E.update_floorplan_overlay=function(e,t){var o;window._all_floorplan_overlays&&(o=T.floorplans.get(e),t?_all_floorplan_overlays[e]&&(_all_floorplan_overlays[e].setMap(null),_all_floorplan_overlays=_.omit(_all_floorplan_overlays,e)):_all_floorplan_overlays[e]=new Ye(o,P))},E.get_placed_nodes=function(){return _.filter(T.nodes,function(e){return Ve(e)})},E.get_unplaced_nodes=function(){return _.filter(T.nodes,function(e){return!Ve(e)})},E.get_rotated_lat_lng=function(e){if(!l)return e;var t=T.floorplans.get(l.key);return t&&t.get("is_geoaligned")?t.rotatedLatLng(e,!0):e},E.force_recenter=function(){var e;T.custom_bounds?(e=T.custom_bounds())&&(qe(!0,"Map fitted to "+T.map_type_label,1500),P.fitBounds(e)):_.chain(V).any(function(e){return e.is_placed}).value()?(qe(!0,"Map fitted to network",1500),ye(!0)):qe(!0,"No devices are placed on the map.",1500)},E.place_on_map=Fe,E.on_data_loaded=T.on_data_loaded,E.map_type_changed=T.map_type_changed,E.set_client_location=function(e,t){we();var o=be(_.extend({},e,{prob_radius:t})),e=z[0];t&&e.getCenter()!=o&&e.setCenter(o),$||(P.panTo(o),t=T.floorplans.get(network_map.current_map_type_id()),e=o=e.getBounds(),t&&(t=t.get("is_geoaligned")?t.getBounds():t.getBounds(network_map.get_overlay(),Qe),rc_ne=o.getNorthEast(),rc_sw=o.getSouthWest(),t.contains(rc_ne)||t.contains(rc_sw)||(e=t)),P.fitBounds(e),P.setCenter(h),$=!0)},E.add_client_location=be,E.clear_client_locations=we,E.get_marker_data=he,E.add_marker_click_handler=ge,E.add_marker_mouseenter_handler=me,E.add_marker_mouseleave_handler=fe,E.undo_node_movement=He,E.state=J,E.update_options=function(e){_.isEqual(T,e)||(_.extend(T,e),V=T.nodes,ae(),E.node_data_updated())},function(e){c=!0,T.no_prefs||(M=new DashboardPrefs(T.prefs_key,"map"),J.set(M.get()),T.save_prefs&&J.on("change",function(){M.set(_.omit(J.toJSON(),"current_node_id"))})),J.on("change",E.node_data_updated),_.each(T.addons,function(e){var t=window.nmAddon[e];Q[e]=t,_.each(t,function(e){_.each(e,function(e,t){A[t]=e})})}),T.current_node_id?(J.set({current_node_id:T.current_node_id},{silent:!0}),t=T.floorplans.reject(function(e){return e.get("is_geoaligned")}),t=_.map(t,function(e){return e.get("node_floorplan_placements").fetch()}),Je.when.apply(this,t).done(function(){ee(e)})):ee(e),T.load_data&&E.on_data_loaded.push(Ae),E._floorplans=T.floorplans;var t=function(){c=!1,E.node_data_updated(),te()};T.disable_fetch?t():T.nodes_list.fetch({success:t})}(Je(this)),_.extend(E,{map:P,nodes:V,container:v}),E}}(jQuery);