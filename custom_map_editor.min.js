/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
MKI.Views.CustomMapEditorRow=MKI.Views.FlexEditorRow.extend({events:_.extend({},MKI.Views.FlexEditor.prototype.events,{"click :not(:disabled) :not(.actions, .fa-remove, .fa-pencil, div)":"overlayMap","click :not(:disabled) .fa-pencil":"editName","click :not(:disabled) .fa-remove":"promptDestroy"}),overlayMap:function(){var e=this.model;geoalign_floorplans.overlayMap(e),!window._all_floorplan_overlays||(o=_all_floorplan_overlays[_current_fp.id])&&$(o._div).addClass("current_overlay");var o=$(".custom_map_control.custom_map_position");e.get("is_geoaligned")?o.find(".fa-search").trigger("mouseout"):o.find(".fa-search").trigger("mouseover")},promptDestroy:function(){var e=this.model,o=$modal_elements.filter("#modal_delete");o.find(".floorplan_name").text(e.get("name")),o.find(".yes").unbind("click").on("click",function(){o.modal("hide"),e.destroy({success:function(e){network_map.update_custom_map_types(e,!0),network_map.update_floorplan_overlay(e.id,!0),$.top_status({box_class:"good",content:"Floorplan deleted",remove_after:5e3}),$("#floor_overlay, #overlay_toolbar").fadeOut(),$(".current_overlay").removeClass("current_overlay"),custom_map_editor.slideOutFloorplanInfo()},error:function(){$.top_status({box_class:"bad",content:"There was an error deleting this floorplan. Please try again.",remove_after:5e3}),MKI.Current.get("ng").get("floorplans").fetch()}})}),o.modal("show")},editName:function(){var t=this.model,a=$modal_elements.filter("#modal_edit");a.modal("show"),a.find(".floorplan_name").text(t.get("name")),a.find(".set_name").unbind("click").on("click",function(){var e=$("#edit_floorplan_name").val(),o=geoalign_floorplans.floorplanInfoInvalid(e);o?a.find("#floorplan_modal_alert").text(o).show():(t.save({name:e},{wait:!0,success:function(){$.top_status({box_class:"good",content:"Floor plan updated",remove_after:5e3})},error:function(){$.top_status({box_class:"bad",content:"Update failed",remove_after:5e3})}}),a.modal("hide"))})}}),MKI.Views.CustomMapEditor=MKI.Views.FlexEditor.extend({defaults:_.extend({},MKI.Views.FlexEditor.prototype.defaults,{selectedColumns:["is_geoaligned","name","nodes","image","asset_missing_in_s3"],remove:!0,editable:!0,sortable:!0}),columns:{is_geoaligned:{label:"Aligned",type:"img",computed:"statusImgUrl"},name:{label:"Name",className:"notranslate"},nodes:{label:"Devices",computed:"numNodes",className:"notranslate"},image:{label:"Image",type:"img",computed:"imageUrl"},asset_missing_in_s3:{type:"html",computed:"assetMissingInS3"}},itemView:MKI.Views.CustomMapEditorRow}),function(){window.custom_map_editor={};var a=$(".upload_floorplan.spinner");function n(e,o){var t=e.affected.length-1,a=e.removed_from.length,e=e.nodes_removed.length;return("f"!==urlHash.getState("move_ap")&&o?"; moved "+pluralize(o,"device")+". ":". ")+(0<t?"Affected "+pluralize(t,"other floorplan")+". ":"")+(e?"Removed "+pluralize(e,"device")+" from "+pluralize(a,"floorplan")+".":"")}custom_map_editor.initAddButton=function(e){var e=$(e),t=$("#floorplan_image_target"),o=e.siblings("form").find(".file_upload"),a=$(".upload_floorplan.spinner"),e=o.siblings("label");custom_map_editor.addButton=e.children(".btn.add"),e.attr("for",""),e.click(function(){o.click()}),o.change(function(){a.show(),$("#floor_overlay, #overlay_toolbar").fadeOut(),$(".current_overlay").removeClass("current_overlay"),$(this).parents("form.upload").submit()}),t.on("load",function(){a.hide();var e,o=t[0].contentWindow.document.body.innerHTML;if("write permission denied"!=o){try{e=JSON.parse(o)}catch(e){return void $.top_status({box_class:"bad",content:"Upload failed",remove_after:5e3})}e.error?"Upload failed: no file supplied NilClass"!=e.error&&$.top_status({box_class:"bad",content:"Upload failed",remove_after:5e3}):(window._uploaded_fp=e,$("#overlay_toolbar").fadeOut(200,function(){$("#upload_info").modal("show")}))}else $.top_status({box_class:"bad",content:"You do not have write permission on this network",remove_after:5e3})})},custom_map_editor.placeAddButton=function(){var e=$("#floorplans_table"),o=custom_map_editor.addButton;network_map._floorplans.size()?($("#upload_message").hide(),e.show(),o.css("left",e.offset().left+e.width()-o.width()-22)):($("#upload_message").show(),e.hide(),o.css("left","415px"))},custom_map_editor.createFloorplan=function(e,o){o=_.extend(o||{},{node_group_id:MKI.Current.get("ng").id});e.set(o),MKI.Current.get("ng").get("floorplans").create(e,{wait:!0,success:function(e){network_map.update_custom_map_types(e),network_map.update_floorplan_overlay(e.id),$.top_status({box_class:"good",content:"Floorplan saved.",remove_after:2500}),_.each(network_map._floorplans.unaligned(),function(e){e.get("node_floorplan_placements").fetch()}),1==network_map._floorplans.size()&&custom_map_editor.slideOutFloorplanInfo()},error:function(e){$.top_status({box_class:"bad",content:"There was an error saving the floorplan. Please try again.",remove_after:5e3})}})},custom_map_editor.updateFloorplan=function(o,e,t){o.get("is_geoaligned")?o.save(e||{},{success:function(e){a.hide(),network_map.node_data_updated(),_all_floorplan_overlays[e.id].draw(),numNodes=e.get("numNodes");var o="Floorplan updated"+n(t,numNodes);$.top_status({box_class:"good",content:o,remove_after:1e4}),MKI.Current.get("ng").get("nodes").fetch({success:function(){network_map.node_data_updated()}}),e.set("new_node_locs",{})},error:function(e){a.hide(),$.top_status({box_class:"bad",content:"There was an error updating the floorplan. Please try again.",remove_after:5e3}),o.set("new_node_locs",{})}}):(e&&_.any(e)&&o.set(e),o.geoalign({success:function(){a.hide(),network_map.node_data_updated(),network_map.update_custom_map_types(o,!0);var e=o.get("numNodes"),e="Successful alignment"+n(t,e);$.top_status({box_class:"good",content:e,remove_after:1e4}),MKI.Current.get("ng").get("nodes").fetch({success:function(){network_map.node_data_updated()}}),_.each(MKI.Current.get("ng").get("floorplans").reject(function(e){return e.get("is_geoaligned")}),function(e){e.get("node_floorplan_placements").fetch()}),o.set("new_node_locs",{})},error:function(){a.hide(),$.top_status({box_class:"bad",content:"There was an error aligning the floorplan. Please try again.",remove_after:5e3})}}))},custom_map_editor.slideOutFloorplanInfo=function(){var e=network_map._floorplans.size(),o=e?376:255,e=e?376:255;$("#floorplan_container").width(o).show(200,function(){$("#floorplan_container").css("overflow-y","auto"),custom_map_editor.placeAddButton()}),$("#map_div").animate({"margin-left":e},200,function(){google.maps.event.trigger(network_map.map,"resize")})},custom_map_editor}();