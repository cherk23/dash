/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(a){window.lt_ping={};var s,o,c=30,e=[];function r(i){"node"==i.type&&(i.runner=a.comet.command_subscribe({broker:"PingAP"},function(n){n.data.completed?p(i):(l(i,n.data.pings),d(i))}));var n,t=this.hasOwnProperty("curr_cli")&&curr_cli.switch||!this.hasOwnProperty("curr_cli")&&"switch"==Mkiconf.network_type;t&&"client"==i.type?(i.node_id=i.node_id||show3.mx_selected_id()||s3node.id,Mkiconf.features.has_mars?i.runner=a.comet.command_subscribe({broker:"PingHost",host:curr_cli.ip},i.node_id,function(n){n.data.completed?p(i):(l(i,n.data.pings),d(i))}):(n=url_for({node_group:i.ng,controller:"nodes"}),n+="/clientarping_data/"+i.node_id+"?client="+encodeURIComponent(i.host),i.runner=live_toolbox.make_grabber_runner(n,function(n,t){if(t.clients){for(var e in t.clients);if(!t.clients[e]||!t.clients[e].arping)return;i.latencies=a.map(t.clients[e].arping.data||[],function(n,t){return n[1]})}"running"!=n&&p(i),d(i)}))):t||"client"!=i.type||(i.node_id=i.node_id||show3.mx_selected_id()||s3node.id,Mkiconf.has_cloud_monitored_device?i.runner=a.comet.command_subscribe({broker:"PingHost",mac:i.host},i.node_id,function(n){n.data.completed?p(i):(l(i,n.data.pings),d(i))}):i.runner=a.comet.command_subscribe({broker:"ArpingHost",mac:i.host},i.node_id,function(n){n.data.completed?p(i):(l(i,n.data.pings),d(i))})),"host"==i.type&&(i.runner=a.comet.command_subscribe({broker:"PingHost",host:i.host},function(n){n.data.completed?p(i):(l(i,n.data.pings),d(i))})),"l3_host"==i.type&&(i.runner=a.comet.command_subscribe({broker:"L3PingHost",dst:i.host,src:i.source},function(n){n.data.completed?p(i):(l(i,n.data.pings),d(i))})),i.running=!0,i.row.find(".ltplay").removeClass("ltplay").addClass("ltstop"),d(i),u()}function l(n,t){t&&0!=t.length&&(n.latencies=(n.latencies||[]).concat(t),n.latencies=n.latencies.slice(-c))}function p(n){n.row.find(".ltstop").removeClass("ltstop").addClass("ltplay"),n.runner&&n.runner.stop(),n.running=!1,u()}function d(n){if(!s||!s.is(":hidden")){if(!n.latencies||0==n.latencies.length)return mkigraph.loading_graph({canvas:n.row.find(".testc_ping_canvas"),yaxis:{min:0,max:100,ticks:mkigraph.tick_generators.msTickGenerator3},xaxis:{show:!1,ticks:[],min:0,max:29}}),void(n.running||n.row.find(".testc_ping_canvas .spinner").remove());var t=n.latencies.slice(-c);t.reverse();var e=0,i=0,o=[];a.each(t,function(n,t){-1==t?(e+=1,o.push(null)):(i+=t,o.push([29-n,t]))});var r="";n.source&&(r+="Source: <var data-var='source'>"+n.source+"</var><br/>"),r+="Loss rate: <var data-var='rate'>"+Math.round(100*e/t.length)+"</var>%<br/>",r+="Average latency: <var data-var='latency'>"+(Math.round(i/(t.length-e))||0)+"</var>ms",a(n.row).find(".agg_data").html(r),a.plot(a(n.row).find(".testc_ping_canvas"),[{data:o,color:"rgba(126,161,180,1)",lines:{show:!0,lineWidth:1,fill:!0,fillColor:"rgba(222,231,236,1)",shadowSize:0}}],{yaxis:{min:0,ticks:mkigraph.tick_generators.msTickGenerator3},xaxis:{show:!1,ticks:[],min:0,max:29}})}}function u(){var e;o&&(e=0,a.each(o,function(n,t){t.running&&e++}),live_toolbox.set_tool_status(lt_ping,0<e),lt_ping.header.find("span").text("Ping"+(1<e?" ("+e+")":"")))}lt_ping.supports_host_pinging=!1,lt_ping.supports_l3_host_pinging=!1,lt_ping.init=function(n){s=n,a("#lt_ping_tmpl").tmpl().appendTo(n),o=[],lt_ping.make_new_ping({type:"node",host:"This "+s3node.devices_noun_abbrev,subtext:s3node.name||s3node.mac,undeletable:!0},"",!0),a("#new_ping_client").focus(function(){var e=[];a.each(Mkijson.c.hash,function(n,t){t&&t.mac&&(t.description?e.push(t.description+" ("+t.mac+")"):e.push(t.mac))}),a(this).typeahead({source:e})}),a("#new_ping_client").enterKey(function(){a("#new_ping").click()}),a("#new_ping").click(function(){return lt_ping.make_new_ping(a("#new_ping_client").val(),a("#new_ping_source").val()),a("#new_ping_client").val(""),!1}),lt_ping.update_interface_menu()},lt_ping.start=function(n){return(o=o||[]).push(n),r(n)},lt_ping.on_show=function(){_.each(o,d),lt_ping.update_interface_menu()},lt_ping.stop=function(){_.each(o,p)},lt_ping.set_interfaces=function(n){for(i in lt_ping.ping_interfaces=n,e=[],n){var t=n[i].ip;e.push(t)}},lt_ping.update_interface_menu=function(){for(i in a("#new_ping_source option").remove(),e){var n=e[i];a("<option></option>").attr("value",n).text(n).appendTo("#new_ping_source")}},lt_ping.make_new_ping=function(n,t,e){var i="string"==typeof n?function(n){var e,i=n.match(/(\w{2}:){5}\w{2}/);if(i)return a.each(Mkijson.c.hash,function(n,t){t.mac==i[0]&&(e=t.description)}),{type:"client",host:i[0],title:e};if(lt_ping.supports_l3_host_pinging)if(!validate.ipv4_validator(n,!0))return{type:"l3_host",host:n};if(lt_ping.supports_host_pinging){n=n.match(/^[\w\.\-]+$/);if(n)return{type:"host",host:n[0]}}return!1}(n):n;if(i){if("l3_host"==i.type){if(!t)return;if(validate.ipv4_validator(t,!0))return;i.source=t}(!o||s.is(":hidden")&&1==o.length)&&live_toolbox.display_tool(lt_ping),(i=a.extend({title:"",subtext:""},i)).row=a("#lt_single_ping").tmpl(i).prependTo(s.find("tbody")),i.row.find(".ltstop").click(function(){return(i.running?p:r)(i),!1}),i.row.find(".delete_col a").click(function(){return p(i),i.row.remove(),remove_element(o,i),!1}),i.undeletable&&i.row.find(".delete_col a").css("visibility","hidden"),o.push(i),(e?p:r)(i)}}}(jQuery);