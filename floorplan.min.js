/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
MKI.Models.Floorplan=Backbone.Epoxy.Model.extend({defaults:{name:"",is_geoaligned:!0,image_extension:null,image_md5:null,ne_lat:null,ne_lng:null,node_ids:"",rotation_angle:0,sw_lat:null,sw_lng:null,node_floorplan_placements:[]},urlRoot:"/floorplans",relations:[{type:Backbone.Many,key:"node_floorplan_placements",collectionType:MKI.Collections.NodeFloorplanPlacements,isTransient:!0}],computeds:{imageUrl:function(){return this.get("image_url")?this.get("image_url"):"/im/"+this.get("image_md5")+"."+this.get("image_extension")},statusImgUrl:function(){return"/images/bubble-shadow-"+(this.get("is_geoaligned")?"1":"red")+".png"},numNodes:function(){var e=this.get("node_ids"),t=this.get("node_floorplan_placements"),n=MKI.Current.get("ng").get("nodes");return this.get("is_geoaligned")?(e=_.filter(e.split(","),function(e){return n.get(e)}))?_.compact(e).length:0:_.compact(t.map(function(e){return n.get(e.get("node_id"))?e:null})).length},assetMissingInS3:function(){if(!this.get("is_missing"))return"<div></div>";return'<span class="splash missing-asset-warning" data-toggle="tooltip" data-placement="bottom" title="Floor plan image not found. Please re-upload."><i class="fa fa-exclamation-triangle Icon"></i></span>'},center:function(){var e=this.get("ne_lat"),t=this.get("ne_lng"),n=this.get("sw_lat"),o=this.get("sw_lng");if(!this.get("is_geoaligned"))return!1;t=new google.maps.LatLng(e,t),o=new google.maps.LatLng(n,o);return google.maps.geometry.spherical.interpolate(t,o,.5)},nodes:function(){var e=this.get("node_ids"),t=this.get("node_floorplan_placements"),n=MKI.Current.get("ng").get("nodes");return n.length?this.get("is_geoaligned")?_.map(_.compact(e.split(",")),function(e){return n.get(e)}):_.compact(t.map(function(e){return n.get(e.get("node_id"))?e:null})):[]}},initialize:function(){_.bindAll(this,"nodeFloorplanPlacementsUrl"),this.get("node_floorplan_placements").url=this.nodeFloorplanPlacementsUrl},nodeFloorplanPlacementsUrl:function(){return"/floorplans/"+this.get("id")+"/node_floorplan_placements"},getBounds:function(e,t){if(this.get("is_geoaligned")){var n=new google.maps.LatLng(this.get("ne_lat"),this.get("ne_lng")),o=new google.maps.LatLng(this.get("sw_lat"),this.get("sw_lng"));return(new google.maps.LatLngBounds).extend(n).extend(o)}var i=e.getMap().getZoom();e.getMap().setZoom(18);var s,a,l=e.getProjection(),g=this.get("width_meters"),n=this.get("height_meters");return a=g&&n?(o=latlng_for(0,0,-n/4,-g/4),s=latlng_for(0,0,n/4,g/4),new google.maps.LatLngBounds(new google.maps.LatLng(o[0],o[1]),new google.maps.LatLng(s[0],s[1]))):(s=this.get("pixel_width"),a=this.get("pixel_length"),t=l.fromLatLngToDivPixel(t),new google.maps.LatLngBounds(l.fromDivPixelToLatLng({x:t.x-s/4,y:t.y+a/4}),l.fromDivPixelToLatLng({x:t.x+s/4,y:t.y-a/4}))),e.getMap().setZoom(i),a},addNode:function(e,t){var n=_.compact(this.get("node_ids").split(",")),t=!!(t||MKI.Current.get("ng").get("nodes")).get(e);if(!this.get("is_geoaligned")||-1<n.indexOf(e)||!t)return!1;n.push(e),this.set({node_ids:n.join(",")})},removeNode:function(e){var t=_.compact(this.get("node_ids").split(","));if(!this.get("is_geoaligned")||-1==t.indexOf(e))return!1;this.set({node_ids:_.without(t,e).join(",")})},hasNode:function(e){var t=this.get("is_geoaligned"),n=this.get("node_floorplan_placements"),o=_.compact(this.get("node_ids").split(","));return!!e&&(!(!t||-1==o.indexOf(e+""))||!(t||!n.findWhere({node_id:e+""})))},geoalign:function(t){var n=this;$.ajax({type:"POST",dataType:"json",url:n.url()+"/geoalign",data:n.toJSON(),success:function(e){n.collection.fetch(),t.success()},error:t.error})},containsLatLng:function(e){var t=this.getBounds();if(!this.get("is_geoaligned"))return!0;e=this.rotatedLatLng(e,!0);return t.contains(e)},rotatedLatLng:function(e,t){if(!this.get("is_geoaligned"))return e;var n=this.get("rotation_angle");if(!n)return e;var o=this.get("center"),i=google.maps.geometry.spherical.computeDistanceBetween(o,e),e=google.maps.geometry.spherical.computeHeading(o,e);return google.maps.geometry.spherical.computeOffset(o,i,e+n*(t?-1:1))}}),MKI.Collections.Floorplans=Backbone.Collection.extend({model:MKI.Models.Floorplan,initialize:function(e,t){var n=this;_.extend(n,t),n.on("reset add remove",function(){n.clearVisibleNodes(),n.trigger("change")})},url:"/floorplans",geoaligned:function(){return this.filter(function(e){return e.get("is_geoaligned")})},unaligned:function(){return this.filter(function(e){return!e.get("is_geoaligned")})},comparator:"name",findByNode:function(t){return this.filter(function(e){return e.hasNode(t)})},clearVisibleNodes:function(){this.each(function(e){e.set("is_map_visible",!0)})},setVisibleNodes:function(t){t?this.each(function(e){e.set("is_map_visible",e.hasNode(t))}):this.clearVisibleNodes()},haveNode:function(t){return t?this.filter(function(e){return e.hasNode(t)}):[]}});