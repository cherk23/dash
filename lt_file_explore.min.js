/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(o){var l,e,t,n,a,i,r,p,s,f,c;function d(){f&&clearInterval(f),o("#stop_rerun").hide(),o("#new_explore").show(),c=!1}function h(e){t=o("#explore_tool_select").attr("value"),o(".fe_hideable_opt").hide(),"cat"==t||"wc"==t?(o("#fe_filename_span").show(),o("#fe_history_span").show(),o("#fe_rerun_span").show()):"head"==t?(o("#fe_filename_span").show(),o("#fe_num_lines_span").show(),o("#fe_history_span").show(),o("#fe_rerun_span").show()):"tail"==t?(o("#fe_num_lines_span").show(),o("#fe_filename_span").show()):"ls"==t?(o("#fe_filename_span").show(),o("#fe_flag_select_span").show(),o("#fe_history_span").show(),o("#fe_rerun_span").show()):"click_read"==t&&(o("#fe_handler_select_span").show(),o("#fe_param_span").show(),o("#fe_history_span").show(),o("#fe_rerun_span").show())}function u(){n=t,c=o("#fe_rerun").is(":checked")&&"tail"!=n,r={command:n,filter:o("#fe_grepexp").val()},"head"==n?(r.broker="CommandFetch",r.file=o("#fe_filename").val(),r.lines=o("#fe_num_lines").val()):"wc"==n||"cat"==n?(r.broker="CommandFetch",r.file=o("#fe_filename").val()):"tail"==n?(r.broker="CommandStream",r.file=o("#fe_filename").val(),r.n=o("#fe_num_lines").val()):"ls"==n?(r.broker="CommandFetch",r.file=o("#fe_filename").val(),_.each(o("#fe_flag_select_span input"),function(e){e=o(e);e[0].checked&&(r[e.val()]=1)})):"click_read"==n&&(r.broker="CommandFetch",r.handler=o("#fe_handler_select").val(),r.param=o("#fe_param").val()),c&&(f&&clearInterval(f),f=window.setInterval(m,2e3)),m()}function m(){lt_file_explore.stop(),o("#new_explore").hide(),o(c?"#stop_rerun":"#stop_explore").show(),(s=o("#fe_history").is(":checked"))||o("#file_explore").text(""),live_toolbox.set_tool_status(lt_file_explore,!0),p=window.setInterval(w,1e3),e=o.comet.command_subscribe(r,x)}function w(){if(a){var e,l=v(a);return"tail"!=n?o("#file_last_fetched").text("Completed at "+l):(e=(new Date).getTime(),e=Math.round((e-a.getTime())/1e3)<=5?" (within last 5 seconds)":" (over 5 seconds ago)",o("#file_last_fetched").text("Node last contacted at "+l+e)),l}}function x(e){o("#download_explore").show();var l=o("#file_explore");a=new Date;var t=w();s&&"tail"!=n&&l.append("\n\n---- Fetched at "+t+" ----\n");t=e.data.chunk;t&&0<t.length&&(l.text(l.text()+t),l.scrollTop(l[0].scrollHeight)),e.data.completed&&lt_file_explore.stop()}function v(e){return unparse_date(e,"%b %-d %H:%M:%S %Z")}function k(){var e,l;r&&a&&(e=document.createElement("a"),l=o("#file_explore").val(),e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(l)),e.setAttribute("id","file_download_link"),l=(r.tool+"_"+r.filename+"_"+v(a)).replace(/[\/ :]/g,"-")+".txt",e.setAttribute("download",l),o("#file_last_fetched").append(e),e.click(),o("#file_download_link").remove())}function b(){o("#file_explore");var e=o("#lt_file_explore_popout").clone().removeAttr("style"),l=o("link[href*='manage.css?mtime'").clone(),t=r.command;e.find("#popout_handler_span").hide(),e.find("#popout_param_span").hide(),e.prepend(l),e.find("#popout_tool").html(t),"tail"==t?(e.find("#popout_filename").html(r.file||"n/a"),e.find("#popout_num_lines").html(r.n||"n/a")):"click_read"==t?(e.find("#popout_handler_span").show(),e.find("#popout_param_span").show(),e.find("#popout_filename_span").hide(),e.find("#popout_num_lines_span").hide(),e.find("#popout_handler").html(r.handler),e.find("#popout_param").html(r.param||"n/a")):"cat"==t||"ls"==t||"wc"==t?(e.find("#popout_num_lines_span").hide(),e.find("#popout_filename").html(r.file||"n/a")):(e.find("#popout_filename").html(r.file||"n/a"),e.find("#popout_num_lines").html(r.lines||"n/a")),e.find("#popout_grepexp").html(r.filter||"n/a"),e.find("#popout_last_seen").html(v(a)),e.find("#popout_file_explore_contents").html(o("#file_explore_contents").html()),e.find("#file_explore").height("calc(100% - 37px)").width("calc(100% - 5px)"),(i=window.open("","_blank","height=600,width=1000,status=yes,toolbar=no,menubar=no,location=no")).document.write(e.html()),i.document.title=r.file}window.lt_file_explore={},lt_file_explore.init=function(e){l=o("#lt_file_explore_tmpl").tmpl().appendTo(e),o("#stop_explore").hide(),o("#stop_explore").click(lt_file_explore.stop),o("#new_explore").click(u),o("#lt_file_explore_popout").hide(),o("#popout_explore").click(b),o("#download_explore").hide(),o("#download_explore").click(k),o("#stop_rerun").hide(),o("#stop_rerun").click(d),o("#lt_file_explore_tool input").not("#fe_filename").keyup(function(e){if(e.which==o.ui.keyCode.ENTER)return u(),!1}),o.each(["cat","tail -f","head","ls","click_read","wc -l"],function(e,l){o("select#explore_tool_select").append(o("<option />",{value:l.split(" ")[0],text:l}))}),o("#explore_tool_select").chosen({placeholder_text:"Select tool"}),o.get(url_for({controller:"nodes",action:"router_files_for_fetch"})).done(function(e){o("#fe_filename").focus(function(){o(this).typeahead({source:JSON.parse(e)})})});o.each(["urlfilter/check_url","geo_painter/lookup","srcr2/mctracker_out/seen_query","srcr2/mctracker_in/seen_query","sw0_ctrl/port_counters_rmon","sw0_ctrl/debug_info","sw0_ctrl/phy_read","sw0_ctrl/acl_counter_read","sw0_ctrl/bcm_fp_entry","sw0_ctrl/mac_table"],function(e,l){o("#fe_handler_select").append(o("<option />",{value:l?l.split("-")[1]:"",text:l}))}),o("#fe_handler_select").chosen({placeholder_text:"Select handler"}),h(),o("#explore_tool_select").change(h),dashhelp("read_file_help","#lt_file_explore_header",{above:!0}),dashhelp("live_tool_filter_help","#fe_filter_span label")},lt_file_explore.stop=function(){e&&e.stop(),c||(o("#stop_explore").hide(),o("#new_explore").show()),p&&clearInterval(p),l.find("#new_explore").text("Fetch"),live_toolbox.set_tool_status(lt_file_explore,!1),"tail"==n&&e&&e.kill(),n=null}}(jQuery);