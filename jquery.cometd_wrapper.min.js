/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(r){var s=!1,c=!1,n=null,o=null,i=null,u={};function d(){var s;c&&(s=(new Date).valueOf(),r.each(u,function(e,t){t.request&&!t.no_keep_alive&&s-t.last_keep_alive>t.keep_alive_interval&&(t.last_keep_alive=s,r.cometd.publish("/requests",r.extend({keep_alive:!0},t.request)))}))}r.comet=function(){},r.comet.init=function(e,t){if(s)return c;r(window).bind("unload.cometd",function(){r.cometd.disconnect()});return o=r.cometd.addListener("/meta/handshake",function(e){t&&t(e),function(e){e.successful&&r.comet.resend_requests();c=e.successful}(e)}),i=r.cometd.addListener("/**",function(e){e.hasOwnProperty("successful")||e.channel.match(/^\/meta/)||"undefined"!=typeof eng_log&&eng_log(e.channel+": ",e)}),r.cometd.init(e),s=!0,n=setInterval(d,1e3),c},r.comet.disconnect=function(){s=!1,clearInterval(n),o&&r.cometd.removeListener(o),i&&r.cometd.removeListener(i),r.cometd.disconnect(),r(window).unbind("unload.cometd")},r.comet.subscribe=function(e,t){var s={handler:t,last_keep_alive:(new Date).valueOf(),keep_alive_interval:28e4,stop:function(){s._sub&&r.cometd.unsubscribe(s._sub),delete u[e]},kill:function(){s._sub&&(r.cometd.publish("/kill",s.request),s.stop())}};return c&&(s._sub=r.cometd.subscribe(e,t)),"undefined"!=typeof eng_log&&eng_log("subscribed to "+e),u[e]=s,u[e]},r.comet.node_subscribe=function(e,t,s,n){if(!s){if(!s3node||!s3node.id)return;s=s3node.iswd&&!s3node.is_switch&&show3.mx_selected_id()?show3.mx_selected_id():s3node.id}t=r.comet.subscribe("/node/"+s+"/"+e,t);return t.request={node_id:s,type:e},n&&(t.request=r.extend(t.request,n)),c&&r.cometd.publish("/requests",t.request),t},r.comet.command_subscribe=function(e,t,s){var n;if("function"==typeof t){if(!s3node||!s3node.id)return;n=s3node.iswd&&!s3node.is_switch&&show3.mx_selected_id()?show3.mx_selected_id():s3node.id,s=t}else n=t;if(n){t=Math.floor(1e3*Math.random()),s=r.comet.subscribe("/node/"+n+"/"+e.broker+"/"+t,s);return s.request=r.extend({node_id:n,type:e.broker,pid:t},e),s.no_keep_alive=!0,(_.contains(["tcpdump","FirewallLog","BlinkLeds"],e.broker)||_.contains(["tail","mtr"],e.command))&&(s.keep_alive_interval=5e3,s.no_keep_alive=!1),c&&r.cometd.publish("/requests",s.request),s}},r.comet.pcc_command_subscribe=function(e,t,s){var n=Math.floor(1e5*Math.random()).toString(16),s=r.comet.subscribe("/pcc/"+e+"/PccCommandFetch/"+n,s);return s.request={org_id:Mkiconf.org_id,ng_id:Mkiconf.ng_id,type:"PccCommandFetch",pcc_machine_id:e,pid:n,command:t},c&&r.cometd.publish("/requests",s.request),s},r.comet.client_subscribe2=function(e,t,s,n){n=r.comet.subscribe("/node_group/"+e.id+"/client/"+t+"/"+s,n);return n.request={ng_id:e.id,client:t,type:s},c&&r.cometd.publish("/requests",n.request),n},r.comet.client_subscribe=function(e,t,s){s=r.comet.subscribe("/node_group/"+Mkiconf.ng_id+"/client/"+e+"/"+t,s);return s.request={ng_id:Mkiconf.ng_id,client:e,type:t},c&&r.cometd.publish("/requests",s.request),s},r.comet.client_node_subscribe=function(e,t,s,n){n=r.comet.subscribe("/node/"+e+"/client/"+t+"/"+s,n);return n.request={node_id:e,client:t,type:s},c&&r.cometd.publish("/requests",n.request),n},r.comet.user_subscribe=function(e,t,s){var n=Mkiconf.user_eid,t=r.comet.subscribe("/user/"+n+"/"+e,t);return t.request={user_eid:n,type:e},s&&(t.request=r.extend(t.request,s)),c&&r.cometd.publish("/requests",t.request),t},r.comet.node_group_subscribe=function(e,t,s){var n=Mkiconf.ng_id;s&&s.ng_type&&(n=Mkiconf[s.ng_type].id);t=r.comet.subscribe("/node_group/"+n+"/"+e,t);return t.request={ng_id:n,type:e},s&&(t.request=r.extend(t.request,s)),c&&r.cometd.publish("/requests",t.request),t},r.comet.org_subscribe=function(e,t,s){t=r.comet.subscribe("/org/"+Mkiconf.org_id+"/"+e,t);return t.request={org_id:Mkiconf.org_id,type:e},s&&(t.request=r.extend(t.request,s)),c&&r.cometd.publish("/requests",t.request),t},r.comet.ssp_subscriber=function(e,t,s,n,o){n=r.comet.subscribe("/ssp/"+e+"/"+s+"/"+t,n);return n.request={scope:"ssp",type:t},"mp"==e?n.request.node_id=s:n.request.pcc_node_id=s,o&&(n.request=r.extend(n.request,o)),c&&r.cometd.publish("/requests",n.request),n},r.comet.ssp_mp_subscribe=r.comet.ssp_subscriber.bind(null,"mp"),r.comet.ssp_sm_subscribe=r.comet.ssp_subscriber.bind(null,"sm"),r.comet.unsubscribe_pattern=function(e){for(var t in u)t.match(e)&&(u[t]._sub&&r.cometd.unsubscribe(u[t]._sub),delete u[t])},r.comet.dump_subscriptions=function(){for(var e in u)console.log(e);return u},r.comet.resend_requests=function(){for(var e in r.cometd.clearSubscriptions(),r.cometd.startBatch(),u){var t=u[e];t._sub=r.cometd.subscribe(e,t.handler),t.request&&r.cometd.publish("/requests",t.request)}r.cometd.endBatch()};var t=org.cometd.JSON.fromJSON;org.cometd.JSON.fromJSON=function(e){return""==e?[]:t(e)},r.cometd.onListenerException=function(e,t,s,n){var o=e&&e.message?e.message:"Error in cometd listener",n={exception:e,subscriptionHandle:t,isListener:s,message:n};console.log(o),log_error&&log_error(o,n)}}(jQuery);