/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(){function r(){var t=this;_.extend(this,{build:function(){this.$container=$('<div class="progress_container" style="display:none"></div>');$('<div class="progress" style="width: 260px"></div>');return this.$progress_bar=$('<div class="bar" style="width: 0%"></div>').appendTo($('<div class="progress" style="width: 260px"></div>').appendTo(this.$container)),this.$marquee=$("<div></div>").appendTo(this.$container),this.$container},set:function(e,r,n){t.$progress_bar.width(e+"%"),n&&n.html_safe?t.$marquee.html(r):t.$marquee.text(r)}})}function e(e){this.options=e;var a=this;_.extend(this,{$input:$(),$error:$(),$progress:{$container:$(),set:function(){}},build:function(){var e=$('<div class="mki_quarantine_uploader"></div>');return this.$input=$('<span class="btn btn-default btn-file flex-item">'+(this.options.button_text||"Browse")+' <input type="file"/></span>').appendTo(e),this.$error=$('<div class="mki_quarantine_marquee" style="display:none"></div>').appendTo(e),this.$progress=new r,this.$progress.build().appendTo(e),this.$input.on("change",a.onfilechange),e},onfilechange:function(e){a.$progress.$container.hide(),a.$error.hide();e=e.target.files;if(!e)return a.onfatalerror('This feature is not supported by your browser. Please use a <a target="_blank" href="http://browsehappy.com/">newer browser</a>.');var r=e[0];if(!r)return a.reset();a.$input.prop("disabled",!0),$(a).trigger(jQuery.Event("before_file_change",{file:r})),a.$progress.set(0,"Verifying <var data-var='file'>"+_.escape(r.name)+"</var>...",{html_safe:!0}),(a.options.preprocessor||function(e,r,n){r()})(r,function(){a.startUpload(r)},a.onerror)},onfatalerror:function(e){return $.top_status({box_class:"bad",content:e}),a.reset()},onerror:function(e,r){return $(a).trigger(jQuery.Event("upload_error",{message:e,details:r})),a.$error.show().text(e),eng_log(e,r),a.reset()},startUpload:function(r){var e=r.name;$.ajax({type:"POST",url:a.options.upload_policy_url,data:{filename:e,category:a.options.category}}).done(function(e){$(a).trigger(jQuery.Event("file_change",{file:r})),a.doUpload(e,r)}).fail(function(e){a.onerror("Failed to fetch upload policy",e)})},doUpload:function(r,e){if(r.error)return a.onerror("Upload failed: "+r.error),a.reset();a.$progress.$container.show();var n=JSON.parse(atob(r.policy)),t=_.find(n.conditions,function(e){return _.contains(e,"content-length-range")});if(t){n=t[1],t=t[2];if(e.size<n)return a.onerror("File is too small. Minimum size is "+unparse_size(n,!0,"B"),e.size),a.reset();if(e.size>t)return a.onerror("File is too large. Maximum size is "+unparse_size(t,!0,"B"),e.size),a.reset()}a.$progress.set(0,"Uploading <var data-var='file'>"+_.escape(r.original_filename)+"</var>...",{html_safe:!0});var o=new FormData;_.each(r.form_data,function(e,r){o.append(r,e)}),o.append("file",e);e=new XMLHttpRequest;e.upload.addEventListener("progress",function(e){a.onUploadProgress(e,r.original_filename)},!1),e.addEventListener("load",function(e){a.onUploadComplete(e,r)},!1),e.addEventListener("error",function(e){a.onUploadFailed(e,r.original_filename)},!1),e.addEventListener("abort",a.onUploadCanceled,!1),e.open("POST",r.endpoint_url,!0),e.send(o)},onUploadProgress:function(e,r){var n={filename:r,originalEvent:e};e.lengthComputable&&(e=Math.round(100*e.loaded/e.total),n.percent=e,a.$progress.set(e,"Uploading <var data-var='file'>"+_.escape(r)+"</var>... <var data-var='percent'>"+_.escape(e)+"</var>%",{html_safe:!0})),$(a).trigger(jQuery.Event("upload_progress",n))},onUploadComplete:function(e,r){var n,t;return $(a).trigger(jQuery.Event("before_complete",{original_filename:r.original_filename,endpoint_url:r.endpoint_url,object_key:r.form_data_key})),204==e.target.status?(a.$progress.set(100),setTimeout((t=r,function(){$(a).trigger(jQuery.Event("upload_complete",{original_filename:t.original_filename,endpoint_url:t.endpoint_url,object_key:t.form_data.key}))}),1e3)):(e=(n=e.target.responseXML.getElementsByTagName("Error")[0]).getElementsByTagName("Message")[0].innerHTML,a.onerror(r.original_filename+": Upload failed: "+e,n)),a.reset()},onUploadFailed:function(e,r){return a.onerror("There was an error attempting to upload the file.",e),a.reset()},onUploadCanceled:function(e){return a.onerror("The upload was canceled or the browser has lost its connection.",e),a.reset()},reset:function(){return a.$input.prop("disabled",!0),!1}})}e.ProgressMarquee=r,window.S3QuarantineUploader=e}();