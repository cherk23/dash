/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(s){window.lt_dhcp_leases={};var i,l,r,e=[],c={},d={},n=!1,a="";function o(){s.each(Mkijson.c.hash,function(e,t){c[t.mac]=e}),n=!0,""!==a&&t(a)}function u(){e.push(s.comet.node_subscribe("DhcpLeases",t)),live_toolbox.set_tool_status(lt_dhcp_leases,!0),l.show(),i.hide()}function t(e){var o,t;n?(o=[],""==e.data&&(e.data="{}"),t=JSON.parse(e.data),s.each(t,function(e,t){var n,a=c[e.toLowerCase()],s=Mkijson.c.hash[a],i=t.hostname||e,l="-";s&&(n='<a href="../usage/list#c='+a+'">'+(i=s.dhcp_hostname||s.netbios_name||s.mdns_name||i)+"</a>");s=_.find(d,function(e){return CIDR(e.subnet).contains(CIDR(t.ip))});s&&(l=s.vlan_id),o.push({name:i,id:c[e],ip:t.ip,vlan:l,r_sec:t.remaining,r_str:(i=t.remaining,e=parseInt(i/86400,10),l=parseInt(i/3600,10)%24,i=parseInt(i/60,10)%60,i=0<e?e+" days"+(0<l?", "+l+" hours":""):0<l?l+" hours"+(0<i?", "+i+" minutes":""):i+" minutes"),link:n})}),r.set_items(o),function(e){var t={};_.each(d,function(e){t[e.vlan_id]||(t[e.vlan_id]=_.extend({},e))}),_.each(e,function(e){t[e.vlan]&&(t[e.vlan].used+=1)});e=_.map(t,function(e,t){var n=CIDR(e.subnet);return{subnet:n.unparse(),total:n.size(),vlan_id:t,used:e.used,free:n.size()-e.used}});flex_table_leases_by_vlan.set_items(e)}(o),s("#lt_dhcp_csv_download").show()):a=e}lt_dhcp_leases.init=function(e){var t=new Date,n=t.getTime()/1e3-604800,a=t.getTime()/1e3;s.getJSON(url_for({controller:"nodes",action:"dhcp_subnet_json"})).done(function(e){d=e.vlans}).always(function(){data3_load.ajax("c",{t0:n,t1:a,f:"mac dhcp_hostname mdns_name netbios_name last_seen_at last_seen_at#"},o)}),tool_html=e,s("#lt_dhcp_leases_tmpl").tmpl().appendTo(e),i=e.find(".ltplay").click(u),l=e.find(".ltstop").click(lt_dhcp_leases.stop),live_toolbox.set_tool_status(lt_dhcp_leases,!0),l.show(),i.hide(),r=make_flex_table({items:[],container:"#dhcp_leases_table",columns:{mac:{l:"Client",render:"[%= item.link || item.name %]",text:"[%= item.name %]",sort_by:function(e){return e.name}},ip:{l:"IP",render:"[%= item.ip %]",sort_by:function(e){return e.ip}},vlan:{l:"VLAN",render:"[%= item.vlan %]",sorter:"#"},remaining:{l:"Expires in",render:"[%= item.r_str %]",sort_by:function(e){return e.r_sec},sorter:"#"}},column_customizer:"#prefs_link_leases",selected_fields:["mac","ip","vlan","remaining"],default_sort:"remaining",row_id_prefix:!0,no_items_html:"No current DHCP leases",footer:!0,keep_page:!0,loading:!0,items_per_page:10}),flex_table_leases_by_vlan=make_flex_table({items:[],container:"#dhcp_leases_by_vlan_table",columns:{subnet:{l:"Subnet"},vlan_id:{l:"VLAN"},used:{l:"Used",render:"[%= item.used + ' (' + (Math.round((item.used / item.total) * 100)).toString() + '%)' %]"},free:{l:"Free",render:"[%= item.free + ' (' + (Math.round((item.free / item.total) * 100)).toString() + '%)' %]"}},selected_fields:["subnet","vlan_id","used","free"],default_sort:"vlan_id",row_id_prefix:!0,no_items_html:"No current DHCP leases",footer:!0,keep_page:!0,loading:!0,items_per_page:10}),s("#lt_dhcp_csv_download").click(function(e){var t=s("#lt_dhcp_csv_form");t.attr("action",window.location.origin+"/nmr/reflect_data");var n=object_to_csv(r.items(),r.columns,r.selected_fields());t.find("input[name='filename']").val("dhcp_leases.csv"),t.find("input[name='format']").val("text/csv"),t.find("input[name='data']").val(n),t.submit(),e.preventDefault()}),u()},lt_dhcp_leases.stop=function(){s.each(e,function(e,t){t.stop()}),e=[],live_toolbox.set_tool_status(lt_dhcp_leases,!1),l.hide(),i.show()}}(jQuery);