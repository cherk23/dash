/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(e){var t;e&&e.ui&&(t=e.ui.mouse.prototype._mouseMove,e.ui.mouse.prototype._mouseMove=function(e){t.apply(this,[e])})}(jQuery),window.map_placement=function(a){var t,r={},o=!1,i=null,l=null,n=24;function s(e){e=parseInt(e.attr("id").match(/\d+/)[0]);return Mkijson.n.hash[e]}function c(e,t){t=t||new GLatLng(0,0),l.is_custom()?function(e,t){for(var n,a=l.map_name(),r=null,o=0;o<floorplans.length;o++)a==floorplans[o].name&&(r=floorplans[o]);r&&(n=0==t.lat()&&0==t.lng(),placement={floorplan_key:r.key,node_id:e.id,deg_north:t.lat(),deg_east:t.lng(),remove:n},jQuery.ajax({type:"POST",url:Mkiconf.floorplan_place_nodes_url,contentType:"application/json",data:JSON.stringify([placement]),success:function(e){floorplan_node_placements=JSON.parse(e),custom_map_placements.rebuild(),p(),i.render()}}))}(e,t):(t=t,l.move_node(e,t),map3&&search_filter&&map3.refresh(search_filter.results,!0))}function p(){var e,n=0;l&&(a.each(Mkijson.n.hash,function(e,t){l.node_is_placed(t)&&n++}),e=Mkijson.n.all.count-n||"0",a("#search_placed_link").html('Placed <var data-var="count">('+_.escape(n)+")</var>"),a("#search_unplaced_link").html('Unplaced <var data-var="count">('+_.escape(e)+")</var>"))}return a("#placementLink").on("click",function(e){e.preventDefault(),"map"==urlHash.getState("m")&&"t"==urlHash.getState("place")?a(window).trigger("hashchange"):urlHash.pushState({m:"map",place:"t"})}),r.set_enabled=function(e){var t;function n(){p(),i.render()}(o||e)&&(o||((t={name:{l:"Name",render:"[%= item.name || item.mac %]"},marker:{render:"[%= render_placement_marker(item) %]"},remove:{render:"[%= render_remove_button(item) %]"}}).status=node_list3_load.table_options.columns.status,Mkiconf.has_blink_button&&(t.blink={render:"[%= render_blink_button(item) %]"}),GEvent.addListener(l.get_gmap(),"maptypechanged",n),GEvent.addListener(l.get_gmap(),"node_moved",n),a("#placelist_hide").on("click",function(e){e.preventDefault(),urlHash.pushState({place:void 0})}),a("#search_placed_link, #search_unplaced_link").on("click",function(e){e.preventDefault();var t=l.is_custom()?l.map_name():"world-map";0<=t.indexOf(" ")&&(t='"'+t+'"');e="search_placed_link"==a(e.target).attr("id")?"":"-";search_filter.setQueryTerm(e+"on-map:"+t)}),i=make_flex_table({items:Mkijson.n.hash,container:"#place_list",className:"nodes_filter",row_id_prefix:"place_item_",selected_fields:["status","name","marker","remove"],items_per_page:5,items_per_page_options:[5],footer:!0,simple_footer:!0,columns:t,row_class_template:"ft[%= index % 2 %] placerow",row_hover:function(e){l.show_tooltip(e,!0)}}),jQuery("#gmap").droppable({drop:function(e,t){var n=7,a=18,a=new GPoint(t.position.left-jQuery(this).offset().left+n,t.position.top-jQuery(this).offset().top+a),a=l.get_gmap().fromContainerPixelToLatLng(a);c(s(t.draggable.parent("tr")),a)}}),a(document).on("click",".blink_button",function(){var e=a(this);e.attr("src")!=Mkiconf.images+"bubble-green-0.png"&&(e.attr("src",Mkiconf.images+"spinner.gif"),s(e.parents("tr")),a.ajax({url:url_for({action:"blink_leds_data/"+node_id}),failure:function(){e.attr("src",Mkiconf.images+"bubble-gray.png")},success:function(){e.attr("src",Mkiconf.images+"bubble-green-1.png"),setTimeout(function(){e.attr("src",Mkiconf.images+"bubble-gray.png")},1e4)},type:"POST"}))}),a(document).on("click",".remove_button",function(){c(s(a(this).parents("tr")),null)}),jQuery(document).on("mouseover","#place_list tr.placerow td:not(.remove)",function(){jQuery(this).data("draggable")||jQuery(this).draggable({appendTo:"body",distance:0,revert:"invalid",helper:function(){return a(this).parent("tr").find(".placement_marker").clone()},cursorAt:{left:9,bottom:-2}})}),"undefined"!=typeof search_filter&&r.update_search(search_filter.results),o=!0),e?(a(".place_hide").hide(),a(".place_show").show(),a("#action_bar").css("marginTop","15px"),a("#gmap").css("margin-left","300px"),r.update_placelist_pagination()):(a(".place_hide").show(),a(".place_show").hide(),a("#action_bar").css("marginTop",""),a("#gmap").css("margin-left","0px")))},r.update_search=function(e){t=e,i&&i.filter(t),p()},r.update_placelist_pagination=function(){var e,t;i&&(jQuery("#map_div:hidden").length||(t=jQuery("#place_list > table"),n=t.find(">tbody tr:first").outerHeight(!0)||n,e=t.find(">thead").outerHeight(!0),t=t.find(">tfoot").outerHeight(!0),t+=a("#place_status").outerHeight(!0),t=(jQuery("#place_container").height()-e-t-5)/n,i.items_per_page(Math.floor(t)),i.render()))},r.set_map=function(e){l=e},window.render_placement_marker=function(e){return"<img class='placement_marker "+(l.node_is_placed(e)?"placed":"")+"' src='"+Mkiconf.images+"dingle-pno-z0/dingle-pno-z0-s"+e["status#"]+"-g"+(e.is_gateway?"1":"0")+".png'title='"+(l.node_is_placed(e)?"Placed":"Unplaced")+"' />"},window.render_blink_button=function(e){return"<img class='blink_button' src='"+Mkiconf.images+"bubble-gray.png' title='Blink AP' />"},window.render_remove_button=function(e){return l.node_is_placed(e)?"<img class='remove_button' src='"+Mkiconf.images+"status_grey.png' title='Remove from map' />":""},r}(jQuery);