/* Some or all contents Copyright (c) 2010-2025 Cisco Systems, Inc., all rights reserved */
!function(d,c){var t=!!d.performance.timing;function l(){return{ts:new Date,DOMNodes:document.querySelectorAll("body *").length,ContentDOMNodes:document.querySelectorAll("#sidetabs_body_container *").length}}function e(){this.t0=t?new Date(d.performance.timing.navigationStart):new Date,this.trackers={},this.events=[],this.logged=!1,this.loadEventEndDone=!1,this.unloadedAt=null,this.loadEventEndCallbacks=[],c(d).on("unload",this.handleWindowUnload.bind(this)),c(d).on("load",this.handleWindowLoad.bind(this))}function n(t,e,n){this.name=t,this.collector=e,this.options=_.extend({},n),this.done=!1,this.options.runFor&&(this.stopAt=new Date,this.stopAt.setMilliseconds(this.stopAt.getMilliseconds()+this.options.runFor)),this.state={};this._callbacks={},_.each(["onHeartbeat","getState"],function(t){_.isFunction(this.options[t])&&(this._callbacks[t]=this.options[t].bind(this))},this);n=this.options.onInitialize;_.isFunction(n)&&n.call(this),this.options.onLoadEventEnd&&e.onLoadEventEnd(this.options.onLoadEventEnd.bind(this)),this.options.heartbeatPeriod&&this.startHeartbeat(),this.logState()}e.prototype.eventsByTracker=function(e){return _.filter(this.events,function(t){return t.name===e})},e.prototype.logEvent=function(t){this.events.push(t),this.trackers[t.name]=t,this.allTrackersDone()&&this.log()},e.prototype.allTrackersDone=function(){return _.all&&_.all(this.trackers,function(t){return t.done})},e.prototype.computeState=function(){var t;Mkiconf&&Mkiconf.controller_name&&Mkiconf.action_name&&(t=Mkiconf.controller_name+"#"+Mkiconf.action_name);var e=l(),n=this.trackers.JSHangTracker.data,i=this.trackers.InitialXhrsTracker.data,a=_.extend({},this.trackers.PerformanceApiTracker.data),o=_.findWhere(this.events,{name:"DOMTracker"}),r=this.trackers.PerformanceMeasures.data;this.unloadedAt&&(s=this.unloadedAt-this.t0,a.mkiUnloadEventStart=s);var s=_.find(this.eventsByTracker("InteractionTracker"),function(t){return t.data&&t.data.event});s&&(a.mkiFirstInteractionAt=s.ts-this.t0);var c=this.eventsByTracker("DOMTracker");_.each(["DOMNodes","ContentDOMNodes"],function(e){var n,i=this.t0;_.each(c,function(t){t.ts>i&&(n?n!==t.data[e]&&(i=t.ts,n=t.data[e]):n=t.data[e])}),a["mki"+e+"StabilizedAt"]=i-this.t0},this);n={initialDOMNodes:o.data.DOMNodes,initialContentDOMNodes:o.data.ContentDOMNodes,loadedDOMNodes:e.DOMNodes,loadedContentDOMNodes:e.ContentDOMNodes,initialXHRs:i.count,failedInitialXHRs:i.failed,hasJSHang:n.hasLongDelay,maximumJSHangTime:n.max};d.MkiJsErrors&&0<d.MkiJsErrors.length&&d.MkiJsErrors.errorCount&&(n.errorCount=d.MkiJsErrors.errorCount()),!this.unloadedAt||0===i.running&&0<i.count?a.mkiInitialDataLoadedAt=i.max:n.outstandingInitialXhrs=i.running;i=!d.performance.getEntriesByName("readyForInteraction").length;r["mki-measure-readyForInteraction"]=i?a.mkiInitialDataLoadedAt:d.performance.getEntriesByName("readyForInteraction")[0].startTime;n=_.extend({},n,r);return{ts:this.t0,timings:a,metrics:n,pageloadRequestId:Mkiconf&&Mkiconf.pageload_request_id,controllerAction:t,networkType:Mkiconf&&Mkiconf.current_ng&&Mkiconf.current_ng.type}},e.prototype.log=function(){var t;this.logged||(this.logged=!0,t=this.computeState(),this.logToServer(t),this.unloadedAt||(t=Math.max(t.timings.mkiInitialDataLoadedAt,t.timings.loadEventEnd),d.newrelic&&t&&(t=new Date(d.performance.timing.navigationStart+t),d.newrelic.finished(t))))},e.prototype.logToServer=function(t){navigator&&navigator.sendBeacon?navigator.sendBeacon("/nmr/browser_metrics/log_performance",JSON.stringify(t)):c.ajax({url:"/nmr/browser_metrics/log_performance",type:"POST",contentType:"application/json",data:JSON.stringify(t)})},e.prototype.handleWindowUnload=function(){this.unloadedAt=new Date,this.log()},e.prototype.onLoadEventEnd=function(t){this.loadEventEndDone?t():this.loadEventEndCallbacks.push(t)},e.prototype.runLoadEventEndCallbacks=function(){_.each(this.loadEventEndCallbacks,function(t){t()})},e.prototype.handleWindowLoad=function(){var t=this;setTimeout(function(){t.loadEventEndDone=!0,t.runLoadEventEndCallbacks.call(t)},0)},n.prototype.updateState=function(t){this.state=t,this.logState()},n.prototype.getState=function(){return this._callbacks.getState?this._callbacks.getState():_.extend({},this.state)},n.prototype.processHeartbeat=function(){this._callbacks.onHeartbeat&&this._callbacks.onHeartbeat()},n.prototype.logState=function(){this.collector&&this.collector.logEvent({name:this.name,ts:new Date,done:this.done,data:this.getState()})},n.prototype.startHeartbeat=function(){this._heartbeatTimeout||(this._heartbeatTimeout=setTimeout(this._runHeartbeat.bind(this),this.options.heartbeatPeriod))},n.prototype._runHeartbeat=function(){this.processHeartbeat(),this.stopHeartbeat||this.stopAt&&!(new Date<=this.stopAt)?this.finish():this._heartbeatTimeout=setTimeout(this._runHeartbeat.bind(this),this.options.heartbeatPeriod)},n.prototype.onLoadEventEnd=function(){this._callbacks.onLoadEventEnd&&this._callbacks.onLoadEventEnd()},n.prototype.finish=function(){this.done=!0,this.logState()};var i=new e;function a(){var n,t=window&&window.performance&&window.performance.timing,i={};return t&&t.toJSON&&(n=t.navigationStart,_.each(t.toJSON(),function(t,e){t-=n;0<t&&(i[e]=t)})),i}function o(t){return t?(t.id&&(e="#"+t.id),t.classList&&t.classList.value&&0<t.classList.length&&(n="."+t.classList.value.split(/\s+/).join(".")),t.nodeName+(e||"")+(n||"")):"";var e,n}function r(t){var e=[o(t)],n=t.parentNode;for(e.push(o(n));n&&!n.id;)n=n.parentNode;return n&&n.id&&e.push(o(n)),e.reverse().join(" ")}new n("PerformanceApiTracker",i,{heartbeatPeriod:1e3,onInitialize:function(){window&&window.performance&&window.performance.timing&&(this.state=a())},onHeartbeat:function(){var t=window&&window.performance&&window.performance.timing;t&&t.loadEventEnd&&(t=a(),this.stopHeartbeat=!0,this.done=!0,this.updateState.call(this,t))}}),new n("DOMTracker",i,{heartbeatPeriod:100,runFor:3e4,onInitialize:function(){this.state=l()},onHeartbeat:function(){var t=l(),e=this.state;t.DOMNodes===e.DOMNodes&&t.ContentDOMNodes===e.ContentDOMNodes||this.updateState(t)}}),new n("InteractionTracker",i,{runFor:2e4,onInitialize:function(){setTimeout(function(){c("body").off("click",t),c("body").off("focusin",e),this.finish()}.bind(this),this.stopAt-new Date);var t=function(t){new Date<this.stopAt&&this.updateState({event:"click",target:r(t.target)})}.bind(this),e=function(t){new Date<this.stopAt&&this.updateState({event:"focus",target:r(t.target)})}.bind(this);c("body").on("click",t),c("body").on("focusin",e)}}),new n("PerformanceMeasures",i,{heartbeatPeriod:1e3,runFor:2e4,onHeartbeat:function(){var t,e=_.extend({},this.state);d.performance&&d.performance.getEntriesByType&&(t=d.performance.getEntriesByType("measure"),_.each(t,function(t){e["mki-measure-"+t.name]=t.duration})),this.updateState(e)}}),new n("JSHangTracker",i,{onInitialize:function(){var a=this,o=[],r=100,s=new Date;s.setMinutes(s.getMinutes()+1),function t(e){var n,i=new Date;i.setMilliseconds(i.getMilliseconds()+r),i<=s?(o.push({scheduled:i}),setTimeout(function(){o[e].actual=new Date,o[e].diff=Math.max(o[e].actual-o[e].scheduled,0),t(e+1)},r)):(n={max:0,total:0},_.each(o,function(t){t.diff>c&&(n.hasLongDelay=!0),t.diff>n.max&&(n.max=t.diff),n.total=n.total+t.diff}),a.updateState(n),a.finish())}(0);var c=100}}),new n("InitialXhrsTracker",i,{onInitialize:function(){var a={};this.state={running:0,count:0,max:0,successful:0,failed:0,total:0};var o=this;function i(t,e,n){e="error"===e||"timeout"===e||"parsererror"===e;s.call(o,(e?t:n)._mkiId,e)}function t(){mkiFetch.onRequest(n)}function n(t){var e;d.performance.timing.loadEventEnd?mkiFetch.offRequest(n):(r(e=_.uniqueId("mkiXhr")),t.then(function(t){s.call(o,e,400<=t.status)}))}function r(t){a[t]={t0:new Date},o.state.count=o.state.count+1,o.state.running=o.state.running+1}function s(t,e){var n=a[t],i=_.extend({},o.state),t=new Date;n&&(i.total=i.total+(t-n.t0),n.t1=t),i.max<t&&(i.max=t),i.running=o.state.running-1,e?i.failed=i.failed+1:i.successful=i.successful+1,o.collector.loadEventEndDone&&0===i.running&&(o.done=!0),o.updateState.call(o,i)}c.ajaxPrefilter(function(t,e,n){o.collector.loadEventEndDone||/cometd|quiet_update|log_error|mini-profiler-resources|browser_metrics/.test(t.url)||(n._mkiId=_.uniqueId("mkiXhr"),r(n._mkiId),n.always(i))}),d.mkiFetch?t():c(d).on("mkiFetchLoaded",t)},onLoadEventEnd:function(){0===this.state.running&&this.finish()},getState:function(){var t=d.performance.timing,e=_.extend({},this.state);return e.max&&(e.max=e.max.getTime()-t.navigationStart),e}}),d.collector=i}(window,jQuery);